<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet href="/feed_style.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="https://www.rssboard.org/media-rss">
  <channel>
    <title>linux on 0xttfx</title>
    <link>https://0xttfx.github.io/tags/linux/</link>
    <description>Recent content in linux on 0xttfx</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <copyright>0xttfx - [BSD-3-Clause](https://spdx.org/licenses/BSD-3-Clause)</copyright>
    <lastBuildDate>Sat, 21 Sep 2024 00:47:01 -0300</lastBuildDate><atom:link href="https://0xttfx.github.io/tags/linux/index.xml" rel="self" type="application/rss+xml" /><icon>https://0xttfx.github.io/img/icon.svg</icon>
    
    
    <item>
      <title>RTFM&amp;AleatoriedadesParaSysAdmin UDEV_Keychron</title>
      <link>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-udev_keychron/</link>
      <pubDate>Sat, 21 Sep 2024 00:47:01 -0300</pubDate>
      
      <guid>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-udev_keychron/</guid>
      <description><![CDATA[<p>Para explorar as features do teclado V10 é utilizado o software <a href="https://usevia.app">usevia.app</a> diretamente pelo navegador! E a parte boa é a sua compatibilidade com Linux.</p>
<ul>
<li>meu cenário:
<ul>
<li>Fedora release 40 (Forty)</li>
<li>Google Chrome</li>
</ul>
</li>
<li>Basta acessar o link do aplicativo <a href="https://usevia.app">usevia.app</a> e clicar em <strong>Authorize device</strong></li>
</ul>
<p><img src="/images/UDEV/useviaauthorize.png" alt="img1"></p>
<blockquote>
<p>[!WARNING]
Porem ao tentar fazer a autorizacão do dispositivo! Ocorre o erro de permissão de acesso</p>
</blockquote>
<p><img src="/images/UDEV/useviaerror.png" alt="img2"></p>
<blockquote>
<p>[!note]
é preciso criar uma regra <code>udev</code> para o driver Linux <a href="https://www.kernel.org/doc/Documentation/hid/hidraw.txt">hidraw</a> que é utilizado para comunicacão com o teclado.</p>
</blockquote>
<h2 id="solucão">Solucão</h2>
<p>Primeiro liste as infos do barramento USB pra coletar os dados do device</p>
<ul>
<li><a href="https://man7.org/linux/man-pages/man8/lsusb.8.html">lsusb</a>
ou</li>
<li><a href="https://man7.org/linux/man-pages/man8/udevadm.8.html">udevadm</a></li>
</ul>
<h4 id="obtendo-os-dados">Obtendo os dados</h4>
<ul>
<li><strong>lsusb</strong>
Sem rodeios</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ lsusb
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Bus <span style="color:#bd93f9">001</span> Device 005: ID 3434:03a1 Keychron Keychron V10
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><blockquote>
<p>[!tip]
<a href="https://man7.org/linux/man-pages/man8/lsusb.8.html#OPTIONS">lsusb</a> -D /dev/bus/usb/001/005</p>
</blockquote>
<ul>
<li><strong>udevadm</strong>
Com o <a href="https://man7.org/linux/man-pages/man8/udevadm.8.html"><code>udevadm</code></a> monitore o sistema <a href="https://mirrors.edge.kernel.org/pub/linux/utils/kernel/hotplug/udev/udev.html">UDEV</a> <a href="https://man7.org/linux/man-pages/man8/udevadm.8.html#OPTIONS"><code>monitor --property</code></a></li>
</ul>
<ol>
<li>remova o teclado</li>
<li>inicie o monitoramento</li>
<li>conecte o teclado</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo udevadm monitor -up |grep -E <span style="color:#f1fa8c">&#34;ID_VENDOR_ID|ID_MODEL_ID|DEVNAME&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">DEVNAME</span><span style="color:#ff79c6">=</span>/dev/bus/usb/001/005
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ID_MODEL_ID</span><span style="color:#ff79c6">=</span>03a1
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ID_VENDOR_ID</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">3434</span>
</span></span></code></pre></div><p>Com o path do device em mãos, também podemos obter dados com o comando <a href="https://man7.org/linux/man-pages/man8/udevadm.8.html"><code>udevadm</code></a> usando a opcão <a href="https://man7.org/linux/man-pages/man8/udevadm.8.html#OPTIONS"><code>info</code></a></p>
<ul>
<li>nos interessa os campos:
<ul>
<li>ID_MODEL_ID</li>
<li>ID_VENDOR_ID</li>
</ul>
</li>
</ul>
<blockquote>
<p>[!tip]
$ sudo udevadm info /dev/bus/usb/001/005 |grep -E &ldquo;ID_VENDOR_ID|ID_MODEL_ID&rdquo;</p>
</blockquote>
<p>Sabemos que:</p>
<ul>
<li>o barramento é: <strong>001</strong></li>
<li>o dispositivo é: <strong>005</strong></li>
<li>o ID do vendor Keychron é: <strong>3434</strong></li>
<li>o ID do produto Keychron V10 é: <strong>03a1</strong></li>
</ul>
<h2 id="regra-udev">Regra UDEV</h2>
<p>Específica para o device <a href="https://www.kernel.org/doc/Documentation/hid/hidraw.txt">hidraw</a></p>
<ul>
<li>
<p>primeiro crie uma variável com o group id do usuário</p>
<ul>
<li>meu usuário é <code>0xttfx</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">USER_GID</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">`</span>id -g 0xttfx<span style="color:#f1fa8c">`</span>
</span></span></code></pre></div></li>
<li>
<p>enfim a regra:</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo --preserve-env<span style="color:#ff79c6">=</span>USER_GID sh -c <span style="color:#f1fa8c">&#39;cat &lt;&lt;EOF &gt; /etc/udev/rules.d/via.rules
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"># Keychron_V10
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">KERNEL==&#34;hidraw*&#34;, SUBSYSTEM==&#34;hidraw&#34;, ATTRS{idVendor}==&#34;3434&#34;, ATTRS{idProduct}==&#34;03a1&#34;, MODE=&#34;0660&#34;, GROUP=&#34;${USER_GID}&#34;, TAG+=&#34;uaccess&#34;, TAG+=&#34;udev-acl&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF&#39;</span>
</span></span></code></pre></div><p>Em seguida recarregue as regras UDEV</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo sh -c <span style="color:#f1fa8c">&#39;udevadm control --reload-rules &amp;&amp; udevadm trigger&#39;</span>
</span></span></code></pre></div><p>Funfando :)
<img src="/images/UDEV/useviaok.png" alt="img3"></p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>RTFM&amp;AleatoriedadesParaSysAdmin PAM_exec</title>
      <link>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-pam_exec/</link>
      <pubDate>Fri, 20 Sep 2024 23:51:45 -0300</pubDate>
      
      <guid>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-pam_exec/</guid>
      <description><![CDATA[<h1 id="pam---módulo-pam_exec-para-execução-de-comando-externo">PAM - módulo pam_exec para execução de comando externo</h1>
<p>Estou participando de um projeto, onde sou o ponto focal para Infra, de uma equipe composta por profissionais de países e empresas diferentes! E fui abordado por um Dev, com o seguinte pedido:</p>
<blockquote>
<p><em>Você consegue criar uma forma de, eu mesmo, fazer o restart da instância secundária do PGSQL do ambiente stage ? Sem me dar acesso ao servidor Linux para rodar um comando! E que seja simples para não gerar uma demanda de projeto para Infra etc&hellip;</em></p>
</blockquote>
<ul>
<li><em>Naturalmente: perguntei o motivo! E prefiro não entrar na questão&hellip;</em></li>
</ul>
<p>Em detrimento do projeto e ambiente: minha diretiva principal também é apoiar com soluções que resolvam bloqueios da equipe!</p>
<p>Dito isso! Veio de imediato em minha mente:</p>
<ul>
<li>posso criar um conta de sistema! Dessa forma não há um shell válido para login
<ul>
<li>com diretório home apenas para o subdiretório ~/.ssh, para armazenar o authorized_keys com a chaves públicas
<ul>
<li>e numa tentativa de login via ssh, onde a chave pública for validada: um <code>systemctl restart ...</code> é então executado.</li>
</ul>
</li>
</ul>
</li>
<li>seguido a ideia, de usar ssh, acho que é possível duas abordagens:
<ul>
<li>usando o módulo <a href="https://man7.org/linux/man-pages/man8/pam_exec.8.html">pam_exec</a> do <a href="https://man7.org/linux/man-pages/man8/PAM.8.html">PAM</a>! Configurado no arquivo de configuração PAM para o SSH: <code>/etc/pam.d/sshd</code></li>
<li>usando o bloco condicional <a href="https://man7.org/linux/man-pages/man5/sshd_config.5.html#DESCRIPTION">Match</a> do <a href="https://man7.org/linux/man-pages/man8/sshd.8.html">SSHD</a> para usar o <a href="https://man7.org/linux/man-pages/man5/sshd_config.5.html">ForceCommand</a></li>
</ul>
</li>
</ul>
<p>Como há muito tempo não brinco com o PAM. Optei por ele!</p>
<ul>
<li>
<p>porém, deixo claro que: não me veio nenhuma outra ideia de como aplicar tecnicamente no Linux! Então, é um favor que você me faz, criticar o que proponho aqui! ;)</p>
</li>
<li>
<p>Conta de sistema</p>
</li>
</ul>
<p>Criando uma conta de sistema que será de uso compartilhado, caso algum outro Dev queira fazer uso também. Para tanto, criaremos também o diretório home para armazenar o subdiretório ~/.ssh para armazenar as chaves públicas SSH.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>useradd -r -s /usr/sbin/nologin -m -c <span style="color:#f1fa8c">&#39;user para restart pgsql&#39;</span> restartpg <span style="color:#ff79c6">&amp;&amp;</span> getent passwd restartpg 
</span></span><span style="display:flex;"><span>restartpg:x:995:986:user para restart pgsql:/home/restartpg:/usr/sbin/nologin
</span></span></code></pre></div><ul>
<li>/etc/ssh/sshd_config</li>
</ul>
<ol>
<li>Porque não precaver&hellip;</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp /etc/ssh/sshd_config<span style="color:#ff79c6">{</span>,.BKP<span style="color:#ff79c6">}</span>
</span></span></code></pre></div><ol start="2">
<li>Garanta que o PAM esteja habilitado!</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># Set this to &#39;yes&#39; to enable PAM authentication, account processing,</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># and session processing. If this is enabled, PAM authentication will</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># be allowed through the KbdInteractiveAuthentication and</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># PasswordAuthentication.  Depending on your PAM configuration,</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># PAM authentication via KbdInteractiveAuthentication may bypass</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># the setting of &#34;PermitRootLogin yes</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># If you just want the PAM account and session checks to run without</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># PAM authentication, then enable this but set PasswordAuthentication</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># and KbdInteractiveAuthentication to &#39;no&#39;.</span>
</span></span><span style="display:flex;"><span>UsePAM yes
</span></span></code></pre></div><ul>
<li>/etc/pam.d/sshd</li>
</ul>
<ol>
<li>Não custa nada fazer um backup do arquivo ;)</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp /etc/pam.d/sshd<span style="color:#ff79c6">{</span>,.BKP<span style="color:#ff79c6">}</span>
</span></span></code></pre></div><ol start="2">
<li>Em seguida inserimos nossa configuração</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#f1fa8c">&lt;&lt;EoF &gt;&gt; /etc/pam.d/sshd 
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"># TCPIP ME - @faioli 10/09/24
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"># reboot postgresql by specific user
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">session    optional     pam_exec.so type=open_session debug log=/var/log/sshpamexec.sh.log seteuid /usr/local/bin/sshpamexec.sh
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EoF</span>
</span></span></code></pre></div><ul>
<li>/usr/local/bin/sshpamexec.sh</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  <span style="color:#6272a4">#!/usr/bin/env bash</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">##</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># Autor: Thiago Torres Faioli - A.K.A: 0xttfx - thiago@tcpip.net.br</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># Função: reiniciar instância PGSQL usando conta de sistema sem shell</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># válido que numa tentativa de login via ssh, onde a chave pública for</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># validada o comando `systemctl restart ...` é então executado.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">##</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># Versão: 0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># Data: 10 de Setembro de 2024</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># Licença: SPDX-License-Identifier: BSD-3-Clause</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">#####################################################################</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># funcao para log</span>
</span></span><span style="display:flex;"><span>  _log_msg<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">local</span> <span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$1</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">local</span> <span style="color:#8be9fd;font-style:italic">tstamp</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>date +<span style="color:#f1fa8c">&#34;%d-%m-%Y %H:%M:%S&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;[</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">tstamp</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">] </span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">msg</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> &gt;&gt; /var/log/sshpamexec.log
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># funcão de restart e status do pgsql</span>
</span></span><span style="display:flex;"><span>  _restartpg <span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>    /usr/bin/systemctl restart postgresql@16-main.service
</span></span><span style="display:flex;"><span>    _log_msg <span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">$(</span>/usr/bin/systemctl status postgresql@16-main.service --no-pager<span style="color:#ff79c6">)</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># variável com parser do fingerprint associado ao último login ssh do usuário restartpg </span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">fprint</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">$(</span>cat /var/log/auth.log |grep -iA1 <span style="color:#f1fa8c">&#34;accepted publickey&#34;</span>|grep -B1 restartpg |grep -oE SHA.*$|/usr/bin/tail -n1<span style="color:#ff79c6">)</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># varoável com arquivo temporário criado para armazenar lista de fingerprit</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># do arquivo authorized_keys do usuário restartpg </span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">filelfp</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">$(</span>mktemp /tmp/listakeyfp-XXX<span style="color:#ff79c6">)</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># inserindo lista de fingerprints </span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> pubkey_file in /home/restartpg/.ssh/authorized_keys; <span style="color:#ff79c6">do</span>
</span></span><span style="display:flex;"><span>    ssh-keygen -lf <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">pubkey_file</span><span style="color:#f1fa8c">}</span> -E sha256
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">done</span> &gt; <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">filelfp</span><span style="color:#f1fa8c">}</span> 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># variárel com parser identificando o fingerprint</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">loginfp</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">$(</span>/usr/bin/grep <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">fprint</span><span style="color:#f1fa8c">}</span> <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">filelfp</span><span style="color:#f1fa8c">}</span>| /usr/bin/awk <span style="color:#f1fa8c">&#39;{print $3,$2}&#39;</span><span style="color:#ff79c6">)</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  _usr_parser <span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">[</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$PAM_USER</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;restartpg&#34;</span> <span style="color:#ff79c6">]</span>; <span style="color:#ff79c6">then</span>
</span></span><span style="display:flex;"><span>    _log_msg <span style="color:#f1fa8c">&#34;- - - -&#34;</span>
</span></span><span style="display:flex;"><span>    _log_msg <span style="color:#f1fa8c">&#34;Usuário </span><span style="color:#8be9fd;font-style:italic">$PAM_USER</span><span style="color:#f1fa8c"> reinicando instância PGSQL&#34;</span>
</span></span><span style="display:flex;"><span>    _log_msg <span style="color:#f1fa8c">&#34;Executado por: </span><span style="color:#8be9fd;font-style:italic">$loginfp</span><span style="color:#f1fa8c">&#34;</span> 
</span></span><span style="display:flex;"><span>    _log_msg <span style="color:#f1fa8c">&#34;-&#34;</span>
</span></span><span style="display:flex;"><span>    _restartpg
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">else</span> 
</span></span><span style="display:flex;"><span>    _log_msg <span style="color:#f1fa8c">&#34;- - - -&#34;</span>
</span></span><span style="display:flex;"><span>    _log_msg <span style="color:#f1fa8c">&#34;Usuário </span><span style="color:#8be9fd;font-style:italic">$PAM_USER</span><span style="color:#f1fa8c">! Script </span><span style="color:#8be9fd;font-style:italic">$0</span><span style="color:#f1fa8c"> ignorado.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">fi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span> 
</span></span><span style="display:flex;"><span>  _usr_parser
</span></span><span style="display:flex;"><span>  rm -f <span style="color:#8be9fd;font-style:italic">$filelfp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">exit</span> <span style="color:#bd93f9">0</span>
</span></span></code></pre></div><ul>
<li>Testando</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ssh -l restartpg srvpgsql1.dns.com
</span></span><span style="display:flex;"><span>Last login: Wed Sep <span style="color:#bd93f9">11</span> 13:24:40 <span style="color:#bd93f9">2024</span> from ???.??.???.???
</span></span><span style="display:flex;"><span>This account is currently not available
</span></span><span style="display:flex;"><span>Connection to srvpgsql1.dns.com <span style="color:#8be9fd;font-style:italic">exit</span> closed.
</span></span></code></pre></div><ul>
<li>/var/log/sshpamexec.log</li>
</ul>
<p>Esse será o log gerado das operações</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tail -30 /var/log/sshpamexec.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>11-09-2024 11:12:32<span style="color:#ff79c6">]</span> - - - -
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>11-09-2024 11:12:32<span style="color:#ff79c6">]</span> Usuário treta! Script /usr/local/bin/sshpamexec.sh ignorado.
</span></span><span style="display:flex;"><span>*** Wed Sep <span style="color:#bd93f9">11</span> 13:24:37 <span style="color:#bd93f9">2024</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>11-09-2024 13:24:37<span style="color:#ff79c6">]</span> - - - -
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>11-09-2024 13:24:37<span style="color:#ff79c6">]</span> Usuário restartpg reinicando instância PGSQL
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>11-09-2024 13:24:37<span style="color:#ff79c6">]</span> Executado por: ltorvalds@tcpip.net.br SHA256:nADfsdJgYyN8UFsfsdfdwer3rf3r33dwe3eiO+QVwZE
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>11-09-2024 13:24:37<span style="color:#ff79c6">]</span> -
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>11-09-2024 13:24:40<span style="color:#ff79c6">]</span> ● postgresql@16-main.service - PostgreSQL Cluster 16-main
</span></span><span style="display:flex;"><span>     Loaded: loaded <span style="color:#ff79c6">(</span>/usr/lib/systemd/system/postgresql@.service; enabled-runtime; preset: enabled<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>     Active: active <span style="color:#ff79c6">(</span>running<span style="color:#ff79c6">)</span> since Wed 2024-09-11 13:24:40 -03; 10ms ago
</span></span><span style="display:flex;"><span>    Process: <span style="color:#bd93f9">38251</span> <span style="color:#8be9fd;font-style:italic">ExecStart</span><span style="color:#ff79c6">=</span>/usr/bin/pg_ctlcluster --skip-systemctl-redirect 16-main start <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">code</span><span style="color:#ff79c6">=</span>exited, <span style="color:#8be9fd;font-style:italic">status</span><span style="color:#ff79c6">=</span>0/SUCCESS<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   Main PID: <span style="color:#bd93f9">38257</span> <span style="color:#ff79c6">(</span>postgres<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      Tasks: <span style="color:#bd93f9">6</span> <span style="color:#ff79c6">(</span>limit: 4657<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>     Memory: 53.4M <span style="color:#ff79c6">(</span>peak: 62.3M<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        CPU: 303ms
</span></span><span style="display:flex;"><span>     CGroup: /system.slice/system-postgresql.slice/postgresql@16-main.service
</span></span><span style="display:flex;"><span>             ├─38257 /usr/lib/postgresql/16/bin/postgres -D /var/lib/postgresql/16/main -c <span style="color:#8be9fd;font-style:italic">config_file</span><span style="color:#ff79c6">=</span>/etc/postgresql/16/main/postgresql.conf
</span></span><span style="display:flex;"><span>             ├─38258 <span style="color:#f1fa8c">&#34;postgres: 16/main: checkpointer &#34;</span>
</span></span><span style="display:flex;"><span>             ├─38259 <span style="color:#f1fa8c">&#34;postgres: 16/main: background writer &#34;</span>
</span></span><span style="display:flex;"><span>             ├─38261 <span style="color:#f1fa8c">&#34;postgres: 16/main: walwriter &#34;</span>
</span></span><span style="display:flex;"><span>             ├─38262 <span style="color:#f1fa8c">&#34;postgres: 16/main: autovacuum launcher &#34;</span>
</span></span><span style="display:flex;"><span>             └─38263 <span style="color:#f1fa8c">&#34;postgres: 16/main: logical replication launcher &#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sep <span style="color:#bd93f9">11</span> 13:24:37 stg-ccp-pgsql1 systemd<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span>: Starting postgresql@16-main.service - PostgreSQL Cluster 16-main...
</span></span><span style="display:flex;"><span>Sep <span style="color:#bd93f9">11</span> 13:24:40 stg-ccp-pgsql1 systemd<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span>: Started postgresql@16-main.service - PostgreSQL Cluster 16-main.
</span></span></code></pre></div>]]></description>
      
    </item>
    
    
    
    <item>
      <title>Cybersecurity DoS DDoS UDP Flood</title>
      <link>https://0xttfx.github.io/posts/cybersecurity-dos-ddos-udp-flood/</link>
      <pubDate>Thu, 09 May 2024 00:38:46 -0300</pubDate>
      
      <guid>https://0xttfx.github.io/posts/cybersecurity-dos-ddos-udp-flood/</guid>
      <description><![CDATA[<p>Um ataque DDoS UDP flood é uma forma de ataque distribuído de negação de serviço que explora serviços vulneráveis na Internet que utilizam o protocolo UDP - User Datagram Protocol para inundar um alvo com uma grande quantidade de tráfego de pacotes UDP. E como cada novo pacote UDP recebido pelo servidor, consome recursos computacionais, rapidamente o servidor vai consumindo seus recursos devido a sobrecarga até exaurir o poder computacional o impedindo de processar e responder requisições normais dos usuários, ficando indisponível.</p>
<p><img src="/images/DDoSUDPflood/UDPflood.drawio.svg" alt="UDPflood.drawio"></p>
<h3 id="funcionamento">Funcionamento</h3>
<ol>
<li>
<p><strong>Inundação UDP</strong>: o atacante fazendo uso de uma botnet envia uma grande quantidade de pacotes UDP contra um alvo.</p>
</li>
<li>
<p><strong>IP Spoofing</strong>: o endereço IP de origem dos pacotes UDP são falsificados para impedir a identificação da origem do ataque.</p>
</li>
<li>
<p><strong>Amplificação de tráfego</strong>: também é aplicado a técnica de amplificação para aumentar o impacto do ataque. Dependendo do serviço vulnerável na Internet, usado pelo atacante, uma pequena requisição UDP irá gerar um resposta com grande quantidade de dados que será encaminhado para o alvo, aumentando ainda mais a sobrecarga na infraestrutura.</p>
</li>
<li>
<p><strong>Sobrecarga dos recursos</strong>: devido a arquitetura do protocolo, a infraestrutura do alvo fica rapidamente sobrecarregada com a quantidade massiva de pacotes UDP recebidos, gerando assim indisponibilidade do serviço para usuários legítimos.</p>
</li>
</ol>
<h3 id="características">Características</h3>
<ul>
<li>
<p><strong>Poder do ataque</strong>: o ataque é relativamente simples de ser realizado e requer poucos recursos do lado do atacante, já que é apenas uma questão de enviar uma grande quantidade de pacotes falsificados.</p>
</li>
<li>
<p><strong>Dificuldade de Rastreamento</strong>: devido ao IP spoofing, rastrear a origem do ataque e aplicar mitigação direcionada fica bem difícil.</p>
</li>
<li>
<p><strong>Impacto na disponibilidade</strong>: é o objetivo do ataque torná-lo inacessível para usuários legítimos.</p>
</li>
</ul>
<h3 id="mitigação">Mitigação</h3>
<ul>
<li><strong>Filtragem de pacotes</strong>: implementar filtros de pacotes para bloquear ou limitar o tráfego UDP suspeito.</li>
<li><strong>Detecção de Amplificação</strong>: identificar e corrigir vulnerabilidades em serviços que podem ser explorados para amplificar tráfego.</li>
<li><strong>Implementação de limites de taxa</strong>: configurar limites de taxa para o tráfego UDP.</li>
<li><strong>Análise de tráfego</strong>: monitorar o tráfego de rede para identificar padrões suspeitos de tráfego UDP para medidas de mitigação proativas.</li>
<li><strong>Serviços de proteção DDoS</strong>: considerar o uso de serviços de proteção DDoS de provedores CDN e segurança que podem detectar e mitigar ataques em tempo real.</li>
<li><strong>Atualização e patches de segurança</strong>: manter sistemas e serviços atualizados com as últimas correções de segurança para mitigar vulnerabilidades conhecidas que podem ser exploradas em ataques.</li>
</ul>
<p>Os ataques DDoS UDP flood representam uma ameaça significativa para a disponibilidade de serviços online e podem ser difíceis de mitigar devido à sua natureza distribuída e à facilidade de execução. A implementação de uma combinação de técnicas de mitigação ainda é a melhor forma de reduzir o impacto desses ataques e manter a disponibilidade dos serviços.</p>
<h4 id="firewalls">Firewalls.</h4>
<p>Algumas técnicas possíveis</p>
<h5 id="nftables">nftables</h5>
<h6 id="limitação-de-taxa-de-pacotes">Limitação de taxa de pacotes</h6>
<p>Limitar a taxa de pacotes UDP por origem ou destino reduz a intensidade do ataque.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nft add table ip filter
</span></span><span style="display:flex;"><span>nft add chain ip filter input <span style="color:#ff79c6">{</span> <span style="color:#8be9fd;font-style:italic">type</span> filter hook input priority <span style="color:#bd93f9">0</span> <span style="color:#f1fa8c">\;</span> <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>nft add rule ip filter input udp limit rate 50/second burst <span style="color:#bd93f9">100</span> packets accept
</span></span><span style="display:flex;"><span>nft add rule ip filter input udp limit rate over 50/second drop
</span></span></code></pre></div><ul>
<li><code>add table ip filter</code>:  cria uma <a href="https://wiki.nftables.org/wiki-nftables/index.php/Configuring_tables#Adding_tables">tabela</a> chamada &ldquo;filter&rdquo; de <a href="https://wiki.nftables.org/wiki-nftables/index.php/Nftables_families">família de endereço</a> &ldquo;ip&rdquo;.</li>
<li><code>add chain ip filter input { type filter hook input priority 0 \; }</code>: adiciona a <a href="https://wiki.nftables.org/wiki-nftables/index.php/Configuring_chains#Adding_base_chains">cadeia</a> base &ldquo;input&rdquo; na tabela &ldquo;filter&rdquo; fazemos um filtro no <a href="https://wiki.nftables.org/wiki-nftables/index.php/Netfilter_hooks">gancho input</a> com <a href="https://wiki.nftables.org/wiki-nftables/index.php/Configuring_chains#Base_chain_priority">prioridade</a> 0.</li>
<li><code>add rule ip filter input ip protocol udp limit rate 50/second burst 100 packets accept</code>: serão aceitos pacotes com taxa abaixo de 50 por segundo com um burst(pico) de 100 pacotes.</li>
<li><code>add rule ip filter input ip protocol udp limit rate over 50/second burst 100 packets drop</code>: pacotes acima do limite de taxa serão descartados.</li>
</ul>
<h6 id="filtragem-de-portas-e-pacotes">Filtragem de portas e pacotes</h6>
<p>Bloquear portas incomuns.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nft add rule ip filter input ip protocol udp dport 0-1023 drop
</span></span></code></pre></div><ul>
<li><code>udp dport 0-1023 drop</code>: descarta pacotes destinados ao intervalo de portas (aqui como exemplo usamos as reservadas).</li>
</ul>
<h6 id="rastreamento-de-conexão">Rastreamento de conexão</h6>
<p>O rastreamento de conexão ajuda a identificar e bloquear pacotes que não fazem parte de um padrão esperado. Apesar do UTP não ser orientado a conexão, o sistema &ldquo;ct&rdquo; trata a transação como uma única conexão rastreada baseada na origem+destino de endereço IP e portas enquanto ela passa pelas funções hook do ct. Por exemplo: o comando host dispara uma query para um servidor DNS criando o &ldquo;ctinfo&rdquo; &ldquo;<a href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/netfilter/nf_conntrack_common.h#L17">IP_CT_NEW</a>&rdquo;! E e quando o pacotes alcança a função hook &ldquo;<a href="https://github.com/torvalds/linux/blob/master/net/netfilter/nf_conntrack_core.c#L1151">help+config</a>&rdquo; o status é &ldquo;<a href="https://github.com/torvalds/linux/blob/master/net/netfilter/nf_conntrack_core.c#L1214">IPS_CONFIRMED</a>&rdquo; e o timeout de 30s e o rastreamento da conexão é adicionado na tabela ct&hellip; Quando o servidor DNS responde a query o sistema reconhece que as características desses pacotes coincidem com a conexão salva na tabela e que ainda está dentro do timeout configurado e então o &ldquo;ctinfo&rdquo; é configurado para &ldquo;IP_CT_ESTABLISHED_REPLY&rdquo; e o &ldquo;status&rdquo; para &ldquo;<a href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/netfilter/nf_conntrack_common.h#L48">IPS_SEEN_REPLY</a>&rdquo; e o timeout é configurado para 30s novamente e se não ocorrer mais nenhum pacote de ambos os hosts, o &ldquo;status&rdquo; é configurado para  &ldquo;<a href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/netfilter/nf_conntrack_common.h#L85">IPS_DYING</a>&rdquo;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nft add rule ip filter input ip protocol udp ct state new,established accept
</span></span><span style="display:flex;"><span>nft add rule ip filter input ip protocol udp ct state invalid drop
</span></span></code></pre></div><ul>
<li><code>udp ct state new,established accept</code>: aceita conexões novas e estabelecidas.</li>
<li><code>udp ct state invalid drop</code>: descarta pacotes considerados inválidos.</li>
</ul>
<h6 id="filtragem-de-pacotes-anômalos-e-fragmentados">Filtragem de pacotes anômalos e fragmentados</h6>
<p>Pacotes com cabeçalhos ou tamanho inconsistentes podem indicar um ataque.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nft add rule ip filter input ip protocol udp ip length <span style="color:#bd93f9">0</span> drop
</span></span><span style="display:flex;"><span>nft add rule ip filter input ip protocol udp ip length 512-65535 drop
</span></span><span style="display:flex;"><span>nft add rule ip filter input ip frag-off !<span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span> ip protocol udp drop
</span></span></code></pre></div><ul>
<li><code>udp ip length 0 drop</code>: descarta pacotes com tamanho zero.</li>
<li><code>udp ip length 512-65535 drop</code>: descarta pacotes com tamanho acima de 512 bytes.</li>
<li><code>ip frag-off != 0 ip protocol udp drop</code>: descartar pacotes IP fragmentados para evitar a recomposição de pacotes maliciosos.</li>
</ul>
<h6 id="filtragem-de-redes-e-ip-suspeitos">Filtragem de redes e IP suspeitos</h6>
<p>Se você identificar fontes de ataques conhecidas, pode criar listas de bloqueio para impedir tráfego desses endereços.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nft add <span style="color:#8be9fd;font-style:italic">set</span> ip filter block_ips <span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">type</span> ipv4_address <span style="color:#f1fa8c">\;</span> timeout 6h <span style="color:#f1fa8c">\;</span> comment <span style="color:#f1fa8c">\&#34;</span>descarta pacotes desses sources<span style="color:#f1fa8c">\&#34;</span> <span style="color:#f1fa8c">\;</span> <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>nft add rule ip filter input ip saddr @block_ips drop
</span></span><span style="display:flex;"><span>nft add element ip filter block_ips <span style="color:#ff79c6">{</span> ?.?.?.?, ?.?.?.?/? <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><ul>
<li><code>add set ip filter block_ips {type ipv4_address \;timeout 6h \;}</code>: cria o <a href="https://wiki.nftables.org/wiki-nftables/index.php/Sets#Named_sets">conjunto</a> &ldquo;block_ips&rdquo; do tipo &ldquo;ipv4_address&rdquo; na tabela &ldquo;filter&rdquo; com para armazenar endereços IP e que serão removidos após 6 horas.</li>
<li><code>add rule ip saddr @block_ips drop</code>: aplica a regra a pacotes cujo endereço de origem esteja no conjunto &ldquo;blocked_ips&rdquo; descartando-os.</li>
<li><code>add element ip filter block_ips { ?.?.?.?, ?.?.?.?/? }</code>: adicionando IP&rsquo;s e blocos CIDR ao conjunto &ldquo;block_ips&rdquo;.</li>
</ul>
<h5 id="ipfw">ipfw</h5>
<h6 id="habilitar-e-limitar-o--log">Habilitar e limitar o  log</h6>
<p>Limitar registros de logs de regras para minimizar ocupação de recursos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sysrc <span style="color:#8be9fd;font-style:italic">firewall_logging</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;YES&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;net.inet.ip.fw.verbose_limit=6&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span></code></pre></div><ul>
<li><code>firewall_logging=&quot;YES&quot;</code>: habilitando log</li>
<li><code>&quot;net.inet.ip.fw.verbose_limit=6&quot;</code>: limitando o número de vezes que a regra é logada por tentativa de conexão.</li>
</ul>
<h6 id="limitação-de-taxa-de-pacotes-1">Limitação de taxa de pacotes</h6>
<p>Limitar a taxa de pacotes UDP por origem ou destino reduz a intensidade do ataque.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ipfw add <span style="color:#bd93f9">090</span> check-state
</span></span><span style="display:flex;"><span>ipfw add <span style="color:#bd93f9">100</span> deny limit src-addr 100/s log udp from any to any
</span></span></code></pre></div><ul>
<li><code>check-state</code>: verifica o estado das conexões para permitir tráfego de conexões estabelecidas ou relacionadas.</li>
<li><code>deny limit src-addr 100/s log udp from any to any</code>: limita a 100 pacotes por segundo por endereço IP e rejeita pacotes excedentes.</li>
</ul>
<h6 id="filtragem-de-portas">Filtragem de portas</h6>
<p>Bloquear portas incomuns.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ipfw add <span style="color:#bd93f9">200</span> deny log udp from any to any dst-port 0-1234
</span></span></code></pre></div><ul>
<li><code>deny log udp from any to any dst-port 0-1234</code>: loga e bloqueia intervalo de portas de destino (aqui como exemplo usamos as reservadas).</li>
</ul>
<h6 id="rastreamento-de-estado">Rastreamento de estado</h6>
<p>O rastreamento de estado permite que o firewall diferencie conexões legítimas de atividades suspeitas.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ipfw add <span style="color:#bd93f9">300</span> allow udp from any to any keep-state
</span></span></code></pre></div><ul>
<li><code>allow udp from any to any keep-state</code>: cria regra UDP dinâmica que corresponde ao tráfego bidirecional entre os endereços e portas de origem e destino para permitir tráfego UDP relacionado.</li>
</ul>
<h6 id="filtragem-de-pacotes-anômalos-e-fragmentados-1">Filtragem de pacotes anômalos e fragmentados</h6>
<p>Pacotes com cabeçalhos ou tamanho inconsistentes podem indicar um ataque.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ipfw add <span style="color:#bd93f9">400</span> deny udp from any to any frag
</span></span><span style="display:flex;"><span>ipfw add <span style="color:#bd93f9">500</span> deny udp from any to any iplen 512-65535
</span></span></code></pre></div><ul>
<li><code>add 400 deny udp from any to any frag</code>: nega todos os pacotes fragmentados para o protocolo UDP.</li>
<li><code>deny udp from any to any iplen 512-65535</code>: descartar pacotes com tamanho maior que 512 bytes, indicando amplificação ou fragmentação maliciosa.</li>
</ul>
<h6 id="uso-de-tabelas-para-bloquear-endereços-ip">Uso de Tabelas para Bloquear Endereços IP</h6>
<p>Outra técnica é usar tabelas para bloquear endereços IP suspeitos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ipfw table <span style="color:#bd93f9">1</span> create <span style="color:#8be9fd;font-style:italic">type</span> addr
</span></span><span style="display:flex;"><span>ipfw table <span style="color:#bd93f9">1</span> add ?.?.?.?/?
</span></span><span style="display:flex;"><span>ipfw add <span style="color:#bd93f9">600</span> deny all from table<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span> to any
</span></span></code></pre></div><ul>
<li><code>ipfw table 1 create type addr</code>: cria tabela para armazenar endereços IP que podem ser usados para rastreio.</li>
<li><code>ipfw table 1 add ?.?.?.?/?</code>: adiciona IP ou bloco de endereços à tabela para bloqueio.</li>
<li><code>ipfw add 600 deny all from table(1) to any</code>: Bloqueia pacotes de endereços IP que estão na tabela &ldquo;1&rdquo;.</li>
</ul>
<h5 id="pf">PF</h5>
<h6 id="limitação-de-taxa-de-pacotes-2">Limitação de taxa de pacotes</h6>
<p>Limitar a taxa de pacotes UDP por origem ou destino reduz a intensidade do ataque.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>table block_ip persist
</span></span><span style="display:flex;"><span>pass in proto udp from any to any port any keep state <span style="color:#ff79c6">(</span>max 10, max-src-conn-rate 5/second, overload block_ip flush<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>block in quick from block_ip
</span></span></code></pre></div><ul>
<li><code>table block_ip persist</code>: cria uma tabela para armazenar endereços IP que não respeitaram o limite imposto pela regra.</li>
<li><code>pass in proto udp from any to any port any keep state (max 10, max-src-conn-rate 5/second, overload block_ip flush)</code>:  mantem o estado de até 10 conexões por endereço IP, limitando a taxa de conexões para 5 por segundo e quando o limite é excedido, o endereço é adicionado na tabela <code>block_ip</code> além de todas as conexões desse endereços serem removidas.</li>
<li><code>block in quick from block_ip</code>: Bloqueia rapidamente qualquer tráfego de endereços na tabela <code>&lt;blocked_ips&gt;</code>. A opção <code>quick</code> garante que a regra seja aplicada imediatamente, sem continuar verificando regras subsequentes.</li>
</ul>
<h6 id="rastreamento-de-estado-1">Rastreamento de estado</h6>
<p>O controle de estados permite que o firewall mantenha o rastreamento das conexões ativas, permitindo identificar tráfego anômalo. Você pode definir regras para permitir apenas tráfego com um estado válido.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pass in proto udp from any to any keep state
</span></span><span style="display:flex;"><span>block in proto udp from any to any keep state <span style="color:#ff79c6">(</span>no-state<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><ul>
<li><code>pass out proto udp from any to any keep state</code>: permite tráfego que faz parte de conexões estabelecidas ou relacionadas.</li>
<li><code>block in proto udp from any to any keep state (no-state)</code>: bloqueia tráfego que não pertence a conexões válidas</li>
</ul>
<h6 id="bloqueio-de-ip">Bloqueio de IP</h6>
<p>Podemos criar uma nova tabela ou fazer uso da tabela já criada para bloquear IPs suspeitos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># Adiciona um endereço IP à tabela</span>
</span></span><span style="display:flex;"><span>table block_ip add ?.?.?.?
</span></span></code></pre></div><ul>
<li><code>table block_ip add ?.?.?.?</code>: adiciona um endereço IP na tabela block_ip para bloqueio.</li>
</ul>
<h6 id="filtragem-por-portas">Filtragem por Portas</h6>
<p>Outra técnica é bloquear portas específicas que possam ser usadas para ataques ou analisar o conteúdo dos pacotes para detectar padrões suspeitos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>block in proto udp from any to any port <span style="color:#bd93f9">53</span>
</span></span></code></pre></div><ul>
<li><code>block in proto udp from any to any port 53</code>: bloqueia pacotes UDP destinados à portas ou range de portas específicas.</li>
</ul>
<h6 id="filtragem-de-pacotes-anômalos-e-fragmentados-2">Filtragem de pacotes anômalos e fragmentados</h6>
<p>Pacotes com características anormais ou malformados ou tamanho inconsistentes podem indicar um ataque.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>block in quick proto udp from any to any port any tagged DOIDAO_UDP_SIZE iplen 512-65535
</span></span><span style="display:flex;"><span>block in quick proto udp from any to any frag
</span></span></code></pre></div><ul>
<li><code>tagged DOIDAO_UDP_SIZE iplen 512-65535</code>: descartar pacotes com tamanho maior que 512 bytes, que indicam também pacotes amplificados.</li>
<li><code>block in quick proto udp from any to any frag</code>: descarta pacotes fragmentados para prevenir amplificação por fragmentação.</li>
</ul>
<h5 id="iptables">iptables</h5>
<h6 id="limitar-a-taxa-de-pacotes">Limitar a taxa de pacotes</h6>
<p>Limitar a taxa de pacotes UDP por origem ou destino reduz a intensidade do ataque.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iptables -A INPUT -p udp -m limit --limit 100/sec --limit-burst <span style="color:#bd93f9">200</span> -j ACCEPT
</span></span></code></pre></div><ul>
<li><code>-p udp</code>: especifica pacotes UDP.</li>
<li><code>-m limit</code>: módulo de limitação de taxa.</li>
<li><code>--limit 100/sec</code>: limita a 100 pacotes por segundo.</li>
<li><code>--limit-burst 200</code>: permite um pico (burst) de até 200 pacotes antes de aplicar a limitação.</li>
<li><code>-j ACCEPT</code>: Aceita pacotes que atendem a esse critério.</li>
</ul>
<h6 id="bloquear-de-portas">Bloquear de portas</h6>
<p>Bloquear portas incomuns.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iptables -A INPUT -p udp --dport 0:1023 -j DROP
</span></span></code></pre></div><ul>
<li><code>--dport 0:1023</code>: intervalo de portas de destino (aqui como exemplo usamos as reservadas).</li>
<li><code>-j DROP</code>: Descarte pacotes que atendem a esse critério.</li>
</ul>
<h6 id="rastreamento-de-conexão-1">Rastreamento de conexão</h6>
<p>O rastreamento de conexão ajuda a identificar e bloquear pacotes que não fazem parte de um padrão esperado.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iptables -A INPUT -p udp -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
</span></span><span style="display:flex;"><span>iptables -A INPUT -p udp -m state --state INVALID -j DROP
</span></span></code></pre></div><ul>
<li><code>-m state</code>: módulo de estado para rastreamento de conexão.</li>
<li><code>--state NEW,ESTABLISHED</code>: conexões novas e estabelecidas..</li>
<li><code>-j ACCEPT</code>: aceita pacotes que atendem a esse critério.</li>
<li><code>--state INVALID</code>: descartar pacotes considerados inválidos ou não solicitados</li>
</ul>
<h6 id="filtragem-de-pacotes-anômalos-e-fragmentados-3">Filtragem de pacotes anômalos e fragmentados</h6>
<p>Pacotes com cabeçalhos inconsistentes podem indicar um ataque.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iptables -A INPUT -p udp --length <span style="color:#bd93f9">0</span> -j DROP
</span></span><span style="display:flex;"><span>iptables -A INPUT -p udp -m length --length 512-65535 -j DROP
</span></span><span style="display:flex;"><span>iptables -A INPUT -p udp -f -j DROP
</span></span></code></pre></div><ul>
<li><code>--length 0 -j DROP</code>: descarta pacotes com comprimento zero, indicando anomalia.</li>
<li><code>-m length --length 512-65535 -j DROP</code>: descarta pacotes com tamanho maior que 512 bytes, indicando pacotes amplificados ou malformados.</li>
<li><code>-f -j DROP</code>: filtra pacotes fragmentados para evitar recomposição.</li>
</ul>
<h6 id="filtragem-de-redes-e-ip-suspeitos-1">Filtragem de redes e IP suspeitos</h6>
<p>Se você identificar fontes de ataques conhecidas, pode criar listas de bloqueio para impedir tráfego desses endereços ou blocos de endereço.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iptables -A INPUT -s 0.0.0.0/0 -j DROP
</span></span></code></pre></div><ul>
<li><code>0.0.0.0/0</code>: endereço ou blocos de endereço (CIDR)</li>
<li><code>-s</code>: Define a origem do pacote.</li>
<li><code>-j DROP</code>: descarte pacotes dessa origem.</li>
</ul>
<h5 id="considerações">Considerações</h5>
<ul>
<li>Antes de aplicar essas regras em um ambiente de produção, teste cuidadosamente para garantir que não afetem tráfegos legítimos da infraestrutura.</li>
<li>Monitore seu sistema após aplicar novas regras para detectar comportamentos inesperados ou interrupções.</li>
<li>A combinação dessas técnicas ajuda a criar uma defesa robusta contra ataques DDoS UDP flood e manter a disponibilidade do serviço mesmo diante de tráfego malicioso</li>
</ul>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>Novu Self Hosting</title>
      <link>https://0xttfx.github.io/posts/novu-self-hosting/</link>
      <pubDate>Sat, 23 Mar 2024 18:42:59 -0300</pubDate>
      
      <guid>https://0xttfx.github.io/posts/novu-self-hosting/</guid>
      <description><![CDATA[<h1 id="novu---the-open-source-notification-infrastructure-for-developers">Novu - The open-source notification infrastructure for developers.</h1>
<p>The objective here is to show the configuration of the .env file and the NGINX reverse proxy, which was my biggest difficulty due to the lack of essential details in the project documentation for this purpose.</p>
<h2 id="how-does-novu-work">How Does Novu Work?</h2>
<p>Novu is based on  two components</p>
<ul>
<li>An API for data exchange</li>
<li>A panel to design notifications and their logical rules</li>
</ul>
<h3 id="architecture">Architecture</h3>
<p>Novu&rsquo;s Object Communication Layer - OCL is a framework that separates communication tasks into specialized components, similar to microservices, that handle specific functions, such as messaging and data management.</p>
<p><img src="/images/Novu/Novu_Architecture_v2.png" alt="architecture"></p>
<h2 id="lets-go">Let&rsquo;s go</h2>
<ul>
<li>Clone Novu repo</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># Go to source folder </span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> /usr/local/src
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Get the code</span>
</span></span><span style="display:flex;"><span>git clone --depth <span style="color:#bd93f9">1</span> https://github.com/novuhq/novu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Go to the docker folder</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> novu/docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Copy the example env file</span>
</span></span><span style="display:flex;"><span>cp .env.example ./local/deployment/.env
</span></span></code></pre></div><ul>
<li>.env</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># Secrets</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># YOU MUST CHANGE THESE BEFORE GOING INTO PRODUCTION</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># used as a secret to verify the JWT token signature</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">JWT_SECRET</span><span style="color:#ff79c6">=</span>&lt;secret&gt;
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># used to encrypt/decrypt the provider credentials</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">STORE_ENCRYPTION_KEY</span><span style="color:#ff79c6">=</span>&lt;key&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Host</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">HOST_NAME</span><span style="color:#ff79c6">=</span>https://novu.yourdns.com.br
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># General</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># available values &#39;dev&#39;, &#39;test&#39;, &#39;production&#39;, &#39;ci&#39;, &#39;local&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">NODE_ENV</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">local</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MONGO_MAX_POOL_SIZE</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">500</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MONGO_MIN_POOL_SIZE</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">100</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># MONGO USER</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MONGO_INITDB_ROOT_USERNAME</span><span style="color:#ff79c6">=</span>root
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># MONGO PASSWORD</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MONGO_INITDB_ROOT_PASSWORD</span><span style="color:#ff79c6">=</span>&lt;password&gt;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MONGO_URL</span><span style="color:#ff79c6">=</span>mongodb://root:&lt;password&gt;@mongodb:27017/novu-db?authSource<span style="color:#ff79c6">=</span>admin
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">REDIS_HOST</span><span style="color:#ff79c6">=</span>redis
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">REDIS_PASSWORD</span><span style="color:#ff79c6">=</span>&lt;password&gt;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">REDIS_CACHE_SERVICE_HOST</span><span style="color:#ff79c6">=</span>redis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># AWS</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">S3_LOCAL_STACK</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$HOST_NAME</span>:4566
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">S3_BUCKET_NAME</span><span style="color:#ff79c6">=</span>novu-local
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">S3_REGION</span><span style="color:#ff79c6">=</span>us-east-1
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">AWS_ACCESS_KEY_ID</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">test</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">AWS_SECRET_ACCESS_KEY</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Ports</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">API_PORT</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">REDIS_PORT</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">6379</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">REDIS_CACHE_SERVICE_PORT</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">6379</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">WS_PORT</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">3002</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Root URL</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">REACT_APP_WS_URL</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$HOST_NAME</span>/ws
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Uncomment this one when deploying Novu in the local environment</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># as Web app local Dockerfile will have to load this to be used.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Deployment version doesn&#39;t need as we inject it with API_ROOT_URL value.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#REACT_APP_API_URL=$HOST_NAME:3000</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">API_ROOT_URL</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$HOST_NAME</span>/api
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">DISABLE_USER_REGISTRATION</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">FRONT_BASE_URL</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$HOST_NAME</span>:4200
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">WIDGET_EMBED_PATH</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$HOST_NAME</span>:4701/embed.umd.min.js
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">WIDGET_URL</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$HOST_NAME</span>/widget
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Context Paths for reverse-proxies</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">GLOBAL_CONTEXT_PATH</span><span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">WEB_CONTEXT_PATH</span><span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">API_CONTEXT_PATH</span><span style="color:#ff79c6">=</span>api
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">WS_CONTEXT_PATH</span><span style="color:#ff79c6">=</span>ws
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">WIDGET_CONTEXT_PATH</span><span style="color:#ff79c6">=</span>widget
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Analytics</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">SENTRY_DSN</span><span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># change these values</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">NEW_RELIC_APP_NAME</span><span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">NEW_RELIC_LICENSE_KEY</span><span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">DISABLE_USER_REGISTRATION</span><span style="color:#ff79c6">=</span>
</span></span></code></pre></div><ul>
<li>NGINX configuration</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#ff79c6">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">listen</span> <span style="color:#bd93f9">80</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">client_max_body_size</span> <span style="color:#f1fa8c">20M</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">server_name</span> <span style="color:#f1fa8c">yourdns.com.br</span> <span style="color:#f1fa8c">xxx.xxx.xxx.xxx</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">access_log</span>  <span style="color:#f1fa8c">/var/log/nginx/novu_access.log</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">error_log</span> <span style="color:#f1fa8c">/var/log/nginx/novu_error.log</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">location</span> <span style="color:#f1fa8c">/</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">proxy_pass</span> <span style="color:#f1fa8c">http://localhost:4200</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">proxy_http_version</span> <span style="color:#bd93f9">1</span><span style="color:#f1fa8c">.1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">(</span><span style="color:#8be9fd;font-style:italic">$request_method</span> = <span style="color:#f1fa8c">OPTIONS)</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">add_header</span> <span style="color:#f1fa8c">&#39;Access-Control-Allow-Origin&#39;</span> <span style="color:#f1fa8c">&#39;*&#39;</span>;
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">add_header</span> <span style="color:#f1fa8c">&#39;Access-Control-Allow-Methods&#39;</span> <span style="color:#f1fa8c">&#39;GET,</span> <span style="color:#f1fa8c">POST,</span> <span style="color:#f1fa8c">PUT,</span> <span style="color:#f1fa8c">DELETE&#39;</span>;
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">add_header</span> <span style="color:#f1fa8c">&#39;Access-Control-Allow-Headers&#39;</span> <span style="color:#f1fa8c">&#39;Content-Type,</span> <span style="color:#f1fa8c">Authorization&#39;</span>;
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">200</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">X-Forwarded-For</span> <span style="color:#8be9fd;font-style:italic">$proxy_add_x_forwarded_for</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Host</span> <span style="color:#8be9fd;font-style:italic">$host</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Upgrade</span> <span style="color:#8be9fd;font-style:italic">$http_upgrade</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Connection</span> <span style="color:#f1fa8c">&#34;upgrade&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">location</span> <span style="color:#f1fa8c">/api</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_pass</span> <span style="color:#f1fa8c">http://localhost:3000/api</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">proxy_http_version</span> <span style="color:#bd93f9">1</span><span style="color:#f1fa8c">.1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">add_header</span> <span style="color:#f1fa8c">&#39;Access-Control-Allow-Origin&#39;</span> <span style="color:#f1fa8c">&#39;*&#39;</span>; 
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">add_header</span> <span style="color:#f1fa8c">&#39;Access-Control-Allow-Methods&#39;</span> <span style="color:#f1fa8c">&#39;GET,</span> <span style="color:#f1fa8c">POST,</span> <span style="color:#f1fa8c">PUT,</span> <span style="color:#f1fa8c">DELETE&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">add_header</span> <span style="color:#f1fa8c">&#39;Access-Control-Allow-Headers&#39;</span> <span style="color:#f1fa8c">&#39;Content-Type,</span> <span style="color:#f1fa8c">Authorization&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">X-Forwarded-For</span> <span style="color:#8be9fd;font-style:italic">$proxy_add_x_forwarded_for</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Host</span> <span style="color:#8be9fd;font-style:italic">$host</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Upgrade</span> <span style="color:#8be9fd;font-style:italic">$http_upgrade</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Connection</span> <span style="color:#f1fa8c">&#34;upgrade&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">location</span> <span style="color:#f1fa8c">/ws</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_pass</span> <span style="color:#f1fa8c">http://localhost:3002/ws</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">proxy_http_version</span> <span style="color:#bd93f9">1</span><span style="color:#f1fa8c">.1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">X-Forwarded-For</span> <span style="color:#8be9fd;font-style:italic">$proxy_add_x_forwarded_for</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Host</span> <span style="color:#8be9fd;font-style:italic">$host</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Upgrade</span> <span style="color:#8be9fd;font-style:italic">$http_upgrade</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Connection</span> <span style="color:#f1fa8c">&#34;upgrade&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">location</span> <span style="color:#f1fa8c">/widget</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">proxy_pass</span> <span style="color:#f1fa8c">http://localhost:4500/widget</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_http_version</span> <span style="color:#bd93f9">1</span><span style="color:#f1fa8c">.1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">X-Forwarded-For</span> <span style="color:#8be9fd;font-style:italic">$proxy_add_x_forwarded_for</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Host</span> <span style="color:#8be9fd;font-style:italic">$host</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Upgrade</span> <span style="color:#8be9fd;font-style:italic">$http_upgrade</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Connection</span> <span style="color:#f1fa8c">&#34;upgrade&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">location</span> <span style="color:#f1fa8c">/socket.io/</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">proxy_pass</span> <span style="color:#f1fa8c">http://localhost:3002</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_http_version</span> <span style="color:#bd93f9">1</span><span style="color:#f1fa8c">.1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">X-Forwarded-For</span> <span style="color:#8be9fd;font-style:italic">$proxy_add_x_forwarded_for</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Host</span> <span style="color:#8be9fd;font-style:italic">$host</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Upgrade</span> <span style="color:#8be9fd;font-style:italic">$http_upgrade</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">proxy_set_header</span> <span style="color:#f1fa8c">Connection</span> <span style="color:#f1fa8c">&#34;upgrade&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># proxy_headers_hash_max_size 512;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># proxy_headers_hash_bucket_size 128;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>Now just be happy :)</p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>RTFM &amp; Aleatoriedades para SysAdmin - Windows Server Troubleshooting</title>
      <link>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-windowsservertroubleshooting/</link>
      <pubDate>Tue, 23 Jan 2024 07:03:36 -0300</pubDate>
      
      <guid>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-windowsservertroubleshooting/</guid>
      <description><![CDATA[<p>Aqui temos uma abordagem simples de identificação de causa raiz para troubleshooting em ambientes Microsoft Windows Server.</p>
<p>Como exemplo estou usando um problema, que a equipe Microsoft de uma multinacional, enfrentou com um produto de mercado que estava causando um alto uso de Non-Paged Pool Memory(memory leak). E que causou, durante uma rotina de madrugada, o travamento de +500 servidores&hellip;</p>
<ul>
<li>eu era de uma equipe multidiciplinar. responsável por virtualização, storage, backup, Unix e Linux e acabei me envolvendo pois as equipes de Segurança e Microsoft estavam apenas trocando acusações e ainda não identificado a causa raiz&hellip;</li>
</ul>
<h2 id="problema">Problema</h2>
<p>Verificado que o <em>non-paged pool</em> está com tamanho anormal</p>
<p><img src="/images/WindowsServerTroubleshooting/unknown_filename.2.png" alt="unknown_filename.2.png"></p>
<ul>
<li>
<p>Conforme documentação da Microsoft, o Non-paged pool, pode ocupar até 75% da memória física.</p>
<ul>
<li>Porém não deve ser considerado como &ldquo;normal&rdquo; o grande uso da mesma, principalmente sem uma investigação etc&hellip;</li>
</ul>
</li>
<li>
<p>O Non-paged Pool são dados na RAM do computador usados ​​pelo kernel e pelos drivers do sistema operacional.</p>
<ul>
<li>Non-paged pool nunca é enviado para o disco (<a href="https://0xttfx.github.io/posts/pagecache/">Page Cache</a>)!  Sempre ficará armazenado na memória física.</li>
</ul>
</li>
<li>
<p>Conforme a minha vivência, leak de memória, é quando um programa que armazena dados no pool de memória não paginável do sistema faz &ldquo;merda&rdquo;. Simples assim!</p>
</li>
</ul>
<h2 id="investigação">Investigação</h2>
<p>Identificando o que está utilizando os <em>Pools Memory</em> no servidor Windão.</p>
<ul>
<li>Para o troubleshooting de Pool Memory é usada a ferramenta <a href="https://learn.microsoft.com/pt-br/windows-hardware/drivers/devtest/poolmon">PoolMon</a> que é um monitor que exibe dados que o Windão coleta sobre alocações de memória dos pools de kernel paginados e não paginados do sistema&hellip;
<ul>
<li>Os dados são agrupados por marca de alocação de pool que evidencia as tags que identificam o software etc&hellip;</li>
</ul>
</li>
</ul>
<p>Chega de conversa! Para tanto abra o <strong>command</strong>  ou <strong>power shell</strong> e navegue até a pasta em que o executável &ldquo;poolmon.exe&rdquo;  está localizado:</p>
<ul>
<li>Pode-se executar a ferramenta para que seja gerado um log:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\Temp\Windows Kits\<span style="color:#bd93f9">10</span>\Tools\x64&gt; poolmon -b -n C:\Temp\log_poolmon.txt
</span></span></code></pre></div><ul>
<li>Ou imprimir na STDOUT:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\Temp\Windows Kits\<span style="color:#bd93f9">10</span>\Tools\x64&gt; poolmon -b
</span></span></code></pre></div><ul>
<li>“-b” executa o aplicativo e organiza os processos em ordem de consumo.</li>
</ul>
<p><img src="/images/WindowsServerTroubleshooting/unknown_filename.png" alt="unknown_filename.png"></p>
<p>Aqui conseguimos ver que no topo da lista, temos o processo com maior consumo de RAM &ldquo;<strong>5053046496</strong>&rdquo; Bytes e sua Tag é &ldquo;<strong>NFeS</strong>&rdquo;.  </p>
<ul>
<li>a TAG é um valor único e que é dado pela fabricante do driver.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>5053046496 / 1024 = 4.934.615,... / 1024 = 4.818,... / 1024 = 4,7...GB
</span></span></code></pre></div><p> Com a tag em mãos, deve-se usar a ferramenta <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/findstr"><strong>findstr</strong></a> que procura por cadeia de caracteres! Dessa forma vamos tentar localizar o arquivo que possui a tag em seu conteúdo&hellip;</p>
<ul>
<li>Vamos em seguida acessar o diretório de drives no Windows:
<ul>
<li><strong>path:</strong> c:\windows\system32\drivers</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\&gt; <span style="color:#8be9fd;font-style:italic">cd </span>c:\windows\system32\drivers
</span></span></code></pre></div><ul>
<li>E executar a tool para a busca da tag</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\Windows\System32\drivers\&gt; findstr /m /l /s NFeS *.sys
</span></span><span style="display:flex;"><span>C:\Windows\System32\drivers\mfeavfk.sys
</span></span></code></pre></div><ul>
<li>/l: pesquisa por caracteres literais</li>
<li>/m: lista apenas resultados correspondentes</li>
<li>/s: pesquisa recursiva</li>
</ul>
<p>Bingo&hellip;.\o/!</p>
<ul>
<li>Identificamos com sucesso um aquivo que possui a tag: &ldquo;<strong>mfeavfk.sys</strong>&rdquo;!</li>
</ul>
<p>Agora para tentar identificar o programa que está usando esse driver.</p>
<ul>
<li>Vamos usar a ferramenta <a href="https://learn.microsoft.com/pt-br/sysinternals/downloads/sigcheck"><strong>sigcheck</strong></a>  que mostra metadados como, por exemplo: o número da versão do arquivo, carimbo de data/hora e detalhes da assinatura digital etc&hellip;</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>C:\&gt; sigcheck c:\Windows\System32\drivers\mfeavfk.sys
</span></span></code></pre></div><p><img src="/images/WindowsServerTroubleshooting/unknown_filename.1.png" alt="unknown_filename.1.png"></p>
<p>Assim identificamos que o proprietário é o <strong>Anti-vírus McAfee</strong>.</p>
<h2 id="sobre-o-arquivo-e-driver-identificado">Sobre o Arquivo e Driver Identificado</h2>
<ul>
<li>
<p>Dados do Host afetado</p>
<ul>
<li>Host: Windows Server</li>
<li>Versão: Windows Server Enterprise 2012 R2 x64</li>
</ul>
</li>
<li>
<p>Versões do produto MCAfee:</p>
<ul>
<li>McAfee Agent - version: 5.6.2.209</li>
<li>McAfee Endpoint Security Plataform - version: 10.6.11910</li>
<li>McAfee Endpoint Security Threat Prevention - version: 10.6.11910</li>
</ul>
</li>
</ul>
<h3 id="informações-relevantes">Informações relevantes</h3>
<p>Dos processos iniciados e drivers utilizados pelo Virus Scan Enterprise no Windão:</p>
<ul>
<li>
<p>O driver <strong>mfeavfk</strong>:</p>
<ul>
<li>é um filtro para verificação de arquivos de sistema e para manter um cache desses arquivos aferidos.
 </li>
</ul>
</li>
<li>
<p>O arquivo <strong>mfeavfk.sys</strong>:</p>
<ul>
<li>é um componente de software do <strong>SYSCORE</strong> da McAfee que opera como <strong>Anti-Virus Filter Link</strong> para os produtos de segurança do McAfee.
<ul>
<li>O <strong>VSE</strong>( VirusScan Enterprise) através do driver <strong>mfeavfk</strong> que opera a nível de kernel, juntamente com o <strong>Microsoft Filter Manager</strong>, consegue verificar o vírus em tempo real e de forma autônoma quando arquivos são abertos ou fechados.
<ul>
<li>Basicamente é assim que a McAfee identifica um vírus manipulando arquivos etc&hellip;</li>
</ul>
</li>
</ul>
</li>
<li><strong>MFEAVFK</strong> é um acrônimo para = McAfee For Enterprise Anti-Virus File Link Filter Driver</li>
</ul>
</li>
<li>
<p>Características</p>
<ul>
<li>Mfeavfk.sys não é essencial para SO e por não ser nativo do sistema causa relativamente poucos problemas.</li>
<li>Mfeavfk.sys está localizado na pasta C:\Windows\System32\drivers</li>
<li>O tamanho do arquivo no Windão tem em média 91.672 bytes.</li>
<li>O driver pode ser iniciado ou parado quando feito de forma canônica.</li>
<li>O programa não está visível no task manager.</li>
<li>É assinado pela Verisign.</li>
<li>Não há descrição detalhada do serviço.</li>
<li>mfeavfk.sys parece ser um arquivo compactado. Portanto, a classificação de segurança técnica é 0% perigosa;
<ul>
<li><strong>no entanto</strong>: ao pesquisar reviews da comunidade a quantidade de problemas relacionados são incontáveis&hellip; :(</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Pesquisando na documentação técnica do produto, é informado pelo fabricante, que programas de backup e criptografia também usam o mesmo mecanismo:</p>
<ul>
<li>Por isso, conflitos e até mesmo corrompimentos de arquivos, podem ocorrer.</li>
<li>Até mesmo quando um vírus, que possui mecanismo de proteção contra o driver &ldquo;mfeavfk&rdquo;, pode gerar problemas críticos ao tentar matar o processo que faz uso do driver etc&hellip;</li>
</ul>
<p>Continuando com a pesquisa, mas agora, tentando cruzar ocorrências do driver &ldquo;mfeavfk.sys&rdquo; e leaks de &ldquo;Non-Paged Pool&rdquo; na base de conhecimento McAfee e Internet:</p>
<ul>
<li>O primeiro matching foi certeiro!
<ul>
<li>Encontrei diversos casos conhecidos pela McAfee do problema que estamos enfrentando e justamente com a mesma versão de SO e Anti-Vírus 😉</li>
<li>Segue link onde o assunto é extensivamente tratado entre clientes e suporte McAfee
<ul>
<li><a href="https://community.mcafee.com/t5/Endpoint-Security-ENS/Nonpaged-pool-memory-leak-mfeavfk-sys-on-multiple-windows-server/td-p/617169">Link original</a> está quebrado! Egraçado como as fabricantes desaparecem com alguns dados &hellip;
<ul>
<li>Mas a <a href="https://web.archive.org/web/20201028165000/https://community.mcafee.com/t5/Endpoint-Security-ENS/Nonpaged-pool-memory-leak-mfeavfk-sys-on-multiple-windows-server/td-p/617169">WayBackMachine</a> salvou uma cópia para a posteridade 😉</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/WindowsServerTroubleshooting/unknown_filename.3.png" alt="unknown_filename.3.png"></p>
<p>Logo em seguida, repassei essa investigação para as equipes de SegInfo e Microfofy para continuidade do troubleshooting&hellip;</p>
<p><strong>Referências</strong></p>
<p><a href="https://kc.mcafee.com/corporate/index?page=content&amp;id=KB65784">https://kc.mcafee.com/corporate/index?page=content&amp;id=KB65784</a>
<a href="https://www.file.net/process/mfeavfk.sys.html">https://www.file.net/process/mfeavfk.sys.html</a>
<a href="https://support.microsoft.com/pt-br/help/177415/how-to-use-memory-pool-monitor-poolmon-exe-to-troubleshoot-kernel-mode">https://support.microsoft.com/pt-br/help/177415/how-to-use-memory-pool-monitor-poolmon-exe-to-troubleshoot-kernel-mode</a>
<a href="https://developer.microsoft.com/pt-br/windows/hardware">https://developer.microsoft.com/pt-br/windows/hardware</a>
<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck">https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck</a>
<a href="https://community.mcafee.com/t5/Endpoint-Security-ENS/Nonpaged-pool-memory-leak-mfeavfk-sys-on-multiple-windows-server/td-p/617169">https://community.mcafee.com/t5/Endpoint-Security-ENS/Nonpaged-pool-memory-leak-mfeavfk-sys-on-multiple-windows-server/td-p/617169</a>
<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/filter-manager-concepts">https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/filter-manager-concepts</a></p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>RTFM&amp;AleatoriedadesParaSysAdmin OCSPStapling</title>
      <link>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-ocspstapling/</link>
      <pubDate>Sun, 21 Jan 2024 20:30:59 -0300</pubDate>
      
      <guid>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-ocspstapling/</guid>
      <description><![CDATA[<p>OSCP Stapling é o servidor Web (e não o navegador) obtendo resposta OCSP com status do certificado armazenando-o em cache, e esses dados são incluídos nas respostas HTTPS junto com o certificado&hellip;</p>
<p>O   <strong>OCSP</strong> - Online Certificate Status Protocol, descrita na <a href="https://datatracker.ietf.org/doc/rfc2560">RFC 2560</a>, é um protocolo útil para determinar o status de um certificado digital X.509 <a href="https://datatracker.ietf.org/doc/html/rfc5280">RFC5280</a> sem exigir <strong>CRL</strong> - Certificate Revocation Lists  descrita na <a href="http://datatracker.ietf.org/doc/rfc2560/">RFC 2560</a> ou como complemento, pois fornece informações <em>oportunas</em> sobre o status de revogação de um certificado (<a href="https://datatracker.ietf.org/doc/rfc2459/">RFC2459 Seção 3.3</a>) que são utilizados por exemplo por transferências de fundos de alto valor ou grandes negociações de ações.</p>
<ul>
<li>
<p>O cliente OCSP emite uma solicitação de status para um <em>OCSP responder</em> e suspende a aceitação do certificado em questão até que o <em>responder</em> forneça uma resposta.</p>
</li>
<li>
<p>Uma OCSP request contém os seguintes dados</p>
<ul>
<li>versão do protocolo</li>
<li>requisição de serviço</li>
<li>identificador do certificado de destino</li>
<li>extensões opcionais que PODEM ser processadas pelo OCSP Responder</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ openssl s_client -status -connect 0xttfx.github.io:443
</span></span><span style="display:flex;"><span>CONNECTED<span style="color:#ff79c6">(</span>00000003<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">depth</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> <span style="color:#8be9fd;font-style:italic">C</span> <span style="color:#ff79c6">=</span> US, <span style="color:#8be9fd;font-style:italic">O</span> <span style="color:#ff79c6">=</span> DigiCert Inc, <span style="color:#8be9fd;font-style:italic">OU</span> <span style="color:#ff79c6">=</span> www.digicert.com, <span style="color:#8be9fd;font-style:italic">CN</span> <span style="color:#ff79c6">=</span> DigiCert Global Root CA
</span></span><span style="display:flex;"><span>verify <span style="color:#ff79c6">return</span>:1
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">depth</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#8be9fd;font-style:italic">C</span> <span style="color:#ff79c6">=</span> US, <span style="color:#8be9fd;font-style:italic">O</span> <span style="color:#ff79c6">=</span> DigiCert Inc, <span style="color:#8be9fd;font-style:italic">CN</span> <span style="color:#ff79c6">=</span> DigiCert TLS RSA SHA256 <span style="color:#bd93f9">2020</span> CA1
</span></span><span style="display:flex;"><span>verify <span style="color:#ff79c6">return</span>:1
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">depth</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> <span style="color:#8be9fd;font-style:italic">C</span> <span style="color:#ff79c6">=</span> US, <span style="color:#8be9fd;font-style:italic">ST</span> <span style="color:#ff79c6">=</span> California, <span style="color:#8be9fd;font-style:italic">L</span> <span style="color:#ff79c6">=</span> San Francisco, <span style="color:#8be9fd;font-style:italic">O</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;GitHub, Inc.&#34;</span>, <span style="color:#8be9fd;font-style:italic">CN</span> <span style="color:#ff79c6">=</span> *.github.io
</span></span><span style="display:flex;"><span>verify <span style="color:#ff79c6">return</span>:1
</span></span><span style="display:flex;"><span>OCSP response: 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">======================================</span>
</span></span><span style="display:flex;"><span>OCSP Response Data:
</span></span><span style="display:flex;"><span>    OCSP Response Status: successful <span style="color:#ff79c6">(</span>0x0<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    Response Type: Basic OCSP Response
</span></span><span style="display:flex;"><span>    Version: <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">(</span>0x0<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    Responder Id: B76BA2EAA8AA848C79EAB4DA0F98B2C59576B9F4
</span></span><span style="display:flex;"><span>    Produced At: Jan <span style="color:#bd93f9">11</span> 12:13:07 <span style="color:#bd93f9">2024</span> GMT
</span></span><span style="display:flex;"><span>    Responses:
</span></span><span style="display:flex;"><span>    Certificate ID:
</span></span><span style="display:flex;"><span>      Hash Algorithm: sha1
</span></span><span style="display:flex;"><span>      Issuer Name Hash: E4E395A229D3D4C1C31FF0980C0B4EC0098AABD8
</span></span><span style="display:flex;"><span>      Issuer Key Hash: B76BA2EAA8AA848C79EAB4DA0F98B2C59576B9F4
</span></span><span style="display:flex;"><span>      Serial Number: 044D72D77CDDA702DD5A67F2A23BBDD9
</span></span><span style="display:flex;"><span>    Cert Status: good
</span></span><span style="display:flex;"><span>    This Update: Jan <span style="color:#bd93f9">11</span> 11:57:01 <span style="color:#bd93f9">2024</span> GMT
</span></span><span style="display:flex;"><span>    Next Update: Jan <span style="color:#bd93f9">18</span> 10:57:01 <span style="color:#bd93f9">2024</span> GMT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span>    Signature Value:
</span></span><span style="display:flex;"><span>        15:e9:8c:5a:f3:19:e5:22:9a:a1:63:7c:c6:f1:fd:18:34:f3:
</span></span><span style="display:flex;"><span>        ea:20:2b:8c:93:63:50:29:17:99:a4:45:72:77:6b:56:8f:68:
</span></span><span style="display:flex;"><span>        f4:78:2b:b6:b2:9d:de:09:ac:1f:df:e4:fb:7d:03:9e:7b:aa:
</span></span><span style="display:flex;"><span>        77:ca:58:bf:4b:0a:2d:08:08:ff:ed:7a:49:03:3c:87:08:08:
</span></span><span style="display:flex;"><span>        df:1b:be:bc:62:5a:42:fc:32:be:bb:46:7e:1b:ac:6d:a1:e8:
</span></span><span style="display:flex;"><span>        f8:38:da:7d:bc:dd:e4:bb:1b:09:ce:e5:1e:4a:97:92:01:f4:
</span></span><span style="display:flex;"><span>        4b:ac:2b:d0:2c:5b:14:d2:29:26:2b:a7:9d:a7:10:93:22:cc:
</span></span><span style="display:flex;"><span>        f4:b8:11:66:a4:34:5e:35:c3:2e:0d:e7:38:0c:ae:c1:15:2f:
</span></span><span style="display:flex;"><span>        32:f3:73:59:fb:9c:9c:6d:24:63:e5:7d:54:24:60:ed:a6:bc:
</span></span><span style="display:flex;"><span>        6a:a1:95:49:f1:fc:29:bf:1a:92:9d:a4:a0:0d:e3:df:fd:79:
</span></span><span style="display:flex;"><span>        76:21:76:c1:cf:cd:8e:fa:3d:89:d9:1f:be:39:1a:44:5a:1b:
</span></span><span style="display:flex;"><span>        89:c1:ff:27:ec:37:f2:8b:ae:b2:e7:08:dd:ee:ca:c0:28:ca:
</span></span><span style="display:flex;"><span>        9a:5b:a9:fe:df:fe:9c:94:dd:fb:1f:44:b2:6b:b3:6e:ac:c3:
</span></span><span style="display:flex;"><span>        24:ef:1a:63:e7:3b:dd:1e:6f:29:21:a3:c0:a7:9e:c3:6a:6a:
</span></span><span style="display:flex;"><span>        fd:a8:e1:21
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">======================================</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>Certificate chain
</span></span><span style="display:flex;"><span> <span style="color:#bd93f9">0</span> s:C <span style="color:#ff79c6">=</span> US, <span style="color:#8be9fd;font-style:italic">ST</span> <span style="color:#ff79c6">=</span> California, <span style="color:#8be9fd;font-style:italic">L</span> <span style="color:#ff79c6">=</span> San Francisco, <span style="color:#8be9fd;font-style:italic">O</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;GitHub, Inc.&#34;</span>, <span style="color:#8be9fd;font-style:italic">CN</span> <span style="color:#ff79c6">=</span> *.github.io
</span></span><span style="display:flex;"><span>   i:C <span style="color:#ff79c6">=</span> US, <span style="color:#8be9fd;font-style:italic">O</span> <span style="color:#ff79c6">=</span> DigiCert Inc, <span style="color:#8be9fd;font-style:italic">CN</span> <span style="color:#ff79c6">=</span> DigiCert TLS RSA SHA256 <span style="color:#bd93f9">2020</span> CA1
</span></span><span style="display:flex;"><span>   a:PKEY: rsaEncryption, <span style="color:#bd93f9">2048</span> <span style="color:#ff79c6">(</span>bit<span style="color:#ff79c6">)</span>; sigalg: RSA-SHA256
</span></span><span style="display:flex;"><span>   v:NotBefore: Feb <span style="color:#bd93f9">21</span> 00:00:00 <span style="color:#bd93f9">2023</span> GMT; NotAfter: Mar <span style="color:#bd93f9">20</span> 23:59:59 <span style="color:#bd93f9">2024</span> GMT
</span></span><span style="display:flex;"><span> <span style="color:#bd93f9">1</span> s:C <span style="color:#ff79c6">=</span> US, <span style="color:#8be9fd;font-style:italic">O</span> <span style="color:#ff79c6">=</span> DigiCert Inc, <span style="color:#8be9fd;font-style:italic">CN</span> <span style="color:#ff79c6">=</span> DigiCert TLS RSA SHA256 <span style="color:#bd93f9">2020</span> CA1
</span></span><span style="display:flex;"><span>   i:C <span style="color:#ff79c6">=</span> US, <span style="color:#8be9fd;font-style:italic">O</span> <span style="color:#ff79c6">=</span> DigiCert Inc, <span style="color:#8be9fd;font-style:italic">OU</span> <span style="color:#ff79c6">=</span> www.digicert.com, <span style="color:#8be9fd;font-style:italic">CN</span> <span style="color:#ff79c6">=</span> DigiCert Global Root CA
</span></span><span style="display:flex;"><span>   a:PKEY: rsaEncryption, <span style="color:#bd93f9">2048</span> <span style="color:#ff79c6">(</span>bit<span style="color:#ff79c6">)</span>; sigalg: RSA-SHA256
</span></span><span style="display:flex;"><span>   v:NotBefore: Apr <span style="color:#bd93f9">14</span> 00:00:00 <span style="color:#bd93f9">2021</span> GMT; NotAfter: Apr <span style="color:#bd93f9">13</span> 23:59:59 <span style="color:#bd93f9">2031</span> GMT
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>Server certificate
</span></span><span style="display:flex;"><span>-----BEGIN CERTIFICATE-----
</span></span><span style="display:flex;"><span>MIIHEjCCBfqgAwIBAgIQBE1y13zdpwLdWmfyoju92TANBgkqhkiG9w0BAQsFADBP
</span></span><span style="display:flex;"><span>MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMSkwJwYDVQQDEyBE
</span></span><span style="display:flex;"><span>aWdpQ2VydCBUTFMgUlNBIFNIQTI1NiAyMDIwIENBMTAeFw0yMzAyMjEwMDAwMDBa
</span></span><span style="display:flex;"><span>Fw0yNDAzMjAyMzU5NTlaMGcxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9y
</span></span><span style="display:flex;"><span>bmlhMRYwFAYDVQQHEw1TYW4gRnJhbmNpc2NvMRUwEwYDVQQKEwxHaXRIdWIsIElu
</span></span><span style="display:flex;"><span>Yy4xFDASBgNVBAMMCyouZ2l0aHViLmlvMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A
</span></span><span style="display:flex;"><span>MIIBCgKCAQEAuLBgDhov8bGGS2TsEZ+meb7oh/GIxbRJmxC7yq/qr75UDHhDf8p7
</span></span><span style="display:flex;"><span>TkVbCyQp8bsj/Bmkx2xwSXZT0wkjZbJIe7Ycqgca4nka+Xpe5xb4pkrVOaPiDfdX
</span></span><span style="display:flex;"><span>7+34CHZbUtqL0OYebi/5D5lLalLKNOGkySAz05foenfFAxAmQYJhR6KvxFY/dqI4
</span></span><span style="display:flex;"><span>y7JwrnJ6Q8F+J6Ne1uP256UwcL0qlid6e/tA0ld3ryMSJ0I6xgtqjL26Le4/nxXu
</span></span><span style="display:flex;"><span>YlekppVQr0OwrHa44Q7Z/1bsdFCGtR+WLNGVBeW3BWeTTp7yWjgfp49DWt48V9pI
</span></span><span style="display:flex;"><span>elDGiDgVyJcsLOz4OQk2vRmNA1ZBZgck4wIDAQABo4ID0DCCA8wwHwYDVR0jBBgw
</span></span><span style="display:flex;"><span>FoAUt2ui6qiqhIx56rTaD5iyxZV2ufQwHQYDVR0OBBYEFI0CHHVazcamQXhpKMP3
</span></span><span style="display:flex;"><span>qqeYO9W7MHsGA1UdEQR0MHKCCyouZ2l0aHViLmlvgglnaXRodWIuaW+CDCouZ2l0
</span></span><span style="display:flex;"><span>aHViLmNvbYIKZ2l0aHViLmNvbYIOd3d3LmdpdGh1Yi5jb22CFyouZ2l0aHVidXNl
</span></span><span style="display:flex;"><span>cmNvbnRlbnQuY29tghVnaXRodWJ1c2VyY29udGVudC5jb20wDgYDVR0PAQH/BAQD
</span></span><span style="display:flex;"><span>AgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjCBjwYDVR0fBIGHMIGE
</span></span><span style="display:flex;"><span>MECgPqA8hjpodHRwOi8vY3JsMy5kaWdpY2VydC5jb20vRGlnaUNlcnRUTFNSU0FT
</span></span><span style="display:flex;"><span>SEEyNTYyMDIwQ0ExLTQuY3JsMECgPqA8hjpodHRwOi8vY3JsNC5kaWdpY2VydC5j
</span></span><span style="display:flex;"><span>b20vRGlnaUNlcnRUTFNSU0FTSEEyNTYyMDIwQ0ExLTQuY3JsMD4GA1UdIAQ3MDUw
</span></span><span style="display:flex;"><span>MwYGZ4EMAQICMCkwJwYIKwYBBQUHAgEWG2h0dHA6Ly93d3cuZGlnaWNlcnQuY29t
</span></span><span style="display:flex;"><span>L0NQUzB/BggrBgEFBQcBAQRzMHEwJAYIKwYBBQUHMAGGGGh0dHA6Ly9vY3NwLmRp
</span></span><span style="display:flex;"><span>Z2ljZXJ0LmNvbTBJBggrBgEFBQcwAoY9aHR0cDovL2NhY2VydHMuZGlnaWNlcnQu
</span></span><span style="display:flex;"><span>Y29tL0RpZ2lDZXJ0VExTUlNBU0hBMjU2MjAyMENBMS0xLmNydDAJBgNVHRMEAjAA
</span></span><span style="display:flex;"><span>MIIBfgYKKwYBBAHWeQIEAgSCAW4EggFqAWgAdwB2/4g/Crb7lVHCYcz1h7o0tKTN
</span></span><span style="display:flex;"><span>uyncaEIKn+ZnTFo6dAAAAYZ0gHV7AAAEAwBIMEYCIQCqfmfSO8MxeeVZ/fJzqqBB
</span></span><span style="display:flex;"><span>p+VqeRDUOUBVGyTTOn43ewIhAJT0S27mmGUlpqNiDADP+Jo8C6kYHF+7U6TY74bH
</span></span><span style="display:flex;"><span>XHAaAHYAc9meiRtMlnigIH1HneayxhzQUV5xGSqMa4AQesF3crUAAAGGdIB1agAA
</span></span><span style="display:flex;"><span>BAMARzBFAiEAguB+XQVANBj2MPcJzbz+LBPrkDDOEO3op52jdHUSW3ICIF0fnYdW
</span></span><span style="display:flex;"><span>qvdtmgQNSns13pAppdQWp4/f/jerNYskI7krAHUASLDja9qmRzQP5WoC+p0w6xxS
</span></span><span style="display:flex;"><span>ActW3SyB2bu/qznYhHMAAAGGdIB1SgAABAMARjBEAiAT/wA2qGGHSKZqBAm84z6q
</span></span><span style="display:flex;"><span>E+dGPQZ1aCMY52pFSfcw8QIgP/SciuZG02X2mBO/miDT2hCp4y5d2sc7FE5PThyC
</span></span><span style="display:flex;"><span>pbMwDQYJKoZIhvcNAQELBQADggEBADekGxEin/yfyWcHj6qGE5/gCB1uDI1l+wN5
</span></span><span style="display:flex;"><span>UMZ2ujCQoKQceRMHuVoYjZdMBXGK0CIXxhmiIosD9iyEcWxV3+KZQ2Xl17e3N0zG
</span></span><span style="display:flex;"><span>yOXx2Kd7B13ruBxQpKOO8Ez4uGpyWb5DDoretV6Pnj9aQ2SCzODedvS+phIKBmi7
</span></span><span style="display:flex;"><span>d+FM70tNZ6/2csdrG5xIU6d/7XYYXPD2xkwkU1dX4UKmPa7h9ZPyavopcgE+twbx
</span></span><span style="display:flex;"><span>LxoOkcXsNb/12jOV3iQSDfXDI41AgtFc694KCOjlg+UKizpemE53T5/cq37OqChP
</span></span><span style="display:flex;"><span>qnlPyb6PYIhua/kgbH84ltba1xEDQ9i4UYfOMiJNZEzEdSfQ498<span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>-----END CERTIFICATE-----
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">subject</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">C</span> <span style="color:#ff79c6">=</span> US, <span style="color:#8be9fd;font-style:italic">ST</span> <span style="color:#ff79c6">=</span> California, <span style="color:#8be9fd;font-style:italic">L</span> <span style="color:#ff79c6">=</span> San Francisco, <span style="color:#8be9fd;font-style:italic">O</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;GitHub, Inc.&#34;</span>, <span style="color:#8be9fd;font-style:italic">CN</span> <span style="color:#ff79c6">=</span> *.github.io
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">issuer</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">C</span> <span style="color:#ff79c6">=</span> US, <span style="color:#8be9fd;font-style:italic">O</span> <span style="color:#ff79c6">=</span> DigiCert Inc, <span style="color:#8be9fd;font-style:italic">CN</span> <span style="color:#ff79c6">=</span> DigiCert TLS RSA SHA256 <span style="color:#bd93f9">2020</span> CA1
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>No client certificate CA names sent
</span></span><span style="display:flex;"><span>Peer signing digest: SHA256
</span></span><span style="display:flex;"><span>Peer signature type: RSA-PSS
</span></span><span style="display:flex;"><span>Server Temp Key: X25519, <span style="color:#bd93f9">253</span> bits
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>SSL handshake has <span style="color:#8be9fd;font-style:italic">read</span> <span style="color:#bd93f9">4060</span> bytes and written <span style="color:#bd93f9">393</span> bytes
</span></span><span style="display:flex;"><span>Verification: OK
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>New, TLSv1.3, Cipher is TLS_AES_128_GCM_SHA256
</span></span><span style="display:flex;"><span>Server public key is <span style="color:#bd93f9">2048</span> bit
</span></span><span style="display:flex;"><span>This TLS version forbids renegotiation.
</span></span><span style="display:flex;"><span>Compression: NONE
</span></span><span style="display:flex;"><span>Expansion: NONE
</span></span><span style="display:flex;"><span>No ALPN negotiated
</span></span><span style="display:flex;"><span>Early data was not sent
</span></span><span style="display:flex;"><span>Verify <span style="color:#ff79c6">return</span> code: <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">(</span>ok<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>Post-Handshake New Session Ticket arrived:
</span></span><span style="display:flex;"><span>SSL-Session:
</span></span><span style="display:flex;"><span>    Protocol  : TLSv1.3
</span></span><span style="display:flex;"><span>    Cipher    : TLS_AES_128_GCM_SHA256
</span></span><span style="display:flex;"><span>    Session-ID: 899A5EB90A464A1A310C86986066E2FCFB68AA146C1846809043BC0C7A739186
</span></span><span style="display:flex;"><span>    Session-ID-ctx: 
</span></span><span style="display:flex;"><span>    Resumption PSK: B24E53F7E7FF18D18BE22EE2ACE052DD858A2226E3F6528E0166A5C90FCA50F5
</span></span><span style="display:flex;"><span>    PSK identity: None
</span></span><span style="display:flex;"><span>    PSK identity hint: None
</span></span><span style="display:flex;"><span>    SRP username: None
</span></span><span style="display:flex;"><span>    TLS session ticket lifetime hint: <span style="color:#bd93f9">3600</span> <span style="color:#ff79c6">(</span>seconds<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    TLS session ticket:
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0000</span> - 1b bb 4f <span style="color:#bd93f9">78</span> <span style="color:#bd93f9">61</span> <span style="color:#bd93f9">17</span> <span style="color:#bd93f9">18</span> f9-dd c9 5c <span style="color:#bd93f9">55</span> da 7e <span style="color:#bd93f9">75</span> f8   ..Oxa.....<span style="color:#f1fa8c">\U</span>.~u.
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0010</span> - f7 <span style="color:#bd93f9">88</span> 9b a1 <span style="color:#bd93f9">26</span> e4 5f 03-8f b7 3d b2 4f be df ac   ....&amp;._...<span style="color:#ff79c6">=</span>.O...
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0020</span> - <span style="color:#bd93f9">24</span> <span style="color:#bd93f9">40</span> e5 4f <span style="color:#bd93f9">46</span> 0d <span style="color:#bd93f9">68</span> a3-e3 <span style="color:#bd93f9">93</span> <span style="color:#bd93f9">76</span> d0 5f bf 6d <span style="color:#bd93f9">11</span>   <span style="color:#8be9fd;font-style:italic">$@</span>.OF.h...v._.m.
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0030</span> - 8a <span style="color:#bd93f9">31</span> <span style="color:#bd93f9">67</span> e8 <span style="color:#bd93f9">75</span> 5d 1f c2-5f <span style="color:#bd93f9">68</span> 6f e9 <span style="color:#bd93f9">27</span> 4c e1 <span style="color:#bd93f9">46</span>   .1g.u<span style="color:#ff79c6">]</span>.._ho.&#39;L.F
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0040</span> - df 8c b2 <span style="color:#bd93f9">92</span> e5 6f bf 0b-48 <span style="color:#bd93f9">09</span> 1b d5 b9 <span style="color:#bd93f9">19</span> b7 9e   .....o..H.......
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0050</span> - <span style="color:#bd93f9">55</span> 9c <span style="color:#bd93f9">04</span> b1 <span style="color:#bd93f9">28</span> ae 4e 90-4b 6b c7 a8 0c b1 <span style="color:#bd93f9">58</span> d2   U...<span style="color:#ff79c6">(</span>.N.Kk....X.
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0060</span> - <span style="color:#bd93f9">46</span> 6a 5c 9c ca 4d ac 52-f5 <span style="color:#bd93f9">74</span> 3a <span style="color:#bd93f9">48</span> <span style="color:#bd93f9">78</span> f7 <span style="color:#bd93f9">22</span> <span style="color:#bd93f9">02</span>   Fj<span style="color:#f1fa8c">\.</span>.M.R.t:Hx.<span style="color:#f1fa8c">&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    0070 - b7 ab 64 78 c0 07 3a 62-d3 47 f2 51 48 2a b4 2e   ..dx..:b.G.QH*..
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    0080 - 96 a7 df a4 cb f1 9b 42-17 a8 0f 03 ba a7 50 63   .......B......Pc
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    0090 - 39 af 34 cd fe 3d b6 52-a1 f2 e9 53 b8 1e ee e1   9.4..=.R...S....
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    Start Time: 1705071930
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    Timeout   : 7200 (sec)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    Verify return code: 0 (ok)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    Extended master secret: no
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    Max Early Data: 0
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">---
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">read R BLOCK
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">closed
</span></span></span></code></pre></div><p>A verificação de status de revogação está disponível para o certificado de entidade final.</p>
<ul>
<li>o protocolo v1 sobre HTTP e o tipo de resposta básica são suportados.</li>
</ul>
<p>O status de revogação é verificado via OCSP quando pelo menos uma destas condições for verdadeira:</p>
<ul>
<li>endereço de URL de um OCSP responder é configurado.</li>
<li>A verificação da Autoridade de Acesso à Informação (AIA) está ativada e o certificado a ser validado tem uma extensão AIA.
<ul>
<li>A extensão AIA deve conter um método de acesso PKIK_AD_AD_OCSP com uma URI que indica o local HTTP do Responder do OCSP.</li>
</ul>
</li>
</ul>
<blockquote>
<p>[!NOTA]
Apenas o primeiro <em>OCSP Responder</em> que é identificado na extensão AIA é consultado para o status de revogação.</p>
</blockquote>
<p>Quando ativado a  verificação de URL e AIA, o URL responder é consultado primeiro.</p>
<ul>
<li>A ordem pode ser mudada configurando o atributo da API Global Security Kit (GSKit) , GSK_OCSP_CHECK_AIA_FIRST.</li>
<li>Consulta para um segundo responder ocorre apenas se o primeiro responder resultar em um status de revogação indeterminado.</li>
</ul>
<p>As sessões cliente com processamento de OCSP habilitado podem solicitar a sessão do servidor para enviar uma resposta do OCSP como parte da negociação de sessão para protocolos TLS TLSv1.3 e TLSv1.2.</p>
<ul>
<li>A sessão cliente processa a resposta do OCSP stapling no servidor, eliminando a necessidade do cliente consultar um do <em>OCSP responder</em> para o status de revogação de certificado.</li>
<li>Uma sessão do servidor também deve ativar o processamento de solicitação de status do certificado, para suportar o stapling do OCSP quando solicitado por um software cliente.</li>
</ul>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>RTFM &amp; Aleatoriedades Para SysAdmin - Old NTP Client</title>
      <link>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-oldntp/</link>
      <pubDate>Tue, 09 Jan 2024 12:08:11 -0300</pubDate>
      
      <guid>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-oldntp/</guid>
      <description><![CDATA[<p>Sempre existe a possibilidade de um dia aparecer um servidor com uma versão de SO não atual precisando que o NTP client seja configurado ou revisado… :)</p>
<ol>
<li>
<p>Instalando o serviço NTP</p>
<ol>
<li>Instale o pacote NTP com o utilitário yum</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ yum install ntp  -y
</span></span></code></pre></div><ol start="2">
<li>Em seguida liste os comandos de administração fornecidos pelo pacote npt</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ ntp&lt;tab&gt;&lt;tab&gt;
</span></span><span style="display:flex;"><span>ntpd        ntpdate     ntpdc       ntp-keygen  ntpq        ntpstat     ntptime
</span></span></code></pre></div><ol start="3">
<li>Inicialize o serviço</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo service ntpd start
</span></span><span style="display:flex;"><span>ou
</span></span><span style="display:flex;"><span>$ sudo /etc/rc.d/init.d/ntpd start
</span></span></code></pre></div><ol start="4">
<li>Ao iniciar o serviço, analise em seguida os logs no /var/log/messages</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo tail /var/log/messages
</span></span><span style="display:flex;"><span>ou
</span></span><span style="display:flex;"><span>$ grep ntpd /var/log/messages
</span></span><span style="display:flex;"><span>Jul <span style="color:#bd93f9">23</span> 13:11:51 labcentos01 yum<span style="color:#ff79c6">[</span>9343<span style="color:#ff79c6">]</span>: Installed: ntpdate-4.2.4p83.el6.centos.x86_64
</span></span><span style="display:flex;"><span> Jul <span style="color:#bd93f9">23</span> 13:12:11 labcentos01 ntpd<span style="color:#ff79c6">[</span>9375<span style="color:#ff79c6">]</span>: ntpd  Fri Feb <span style="color:#bd93f9">22</span> 11:23:27 UTC <span style="color:#bd93f9">2013</span> <span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span> Jul <span style="color:#bd93f9">23</span> 13:12:11 labcentos01 ntpd<span style="color:#ff79c6">[</span>9376<span style="color:#ff79c6">]</span>: <span style="color:#8be9fd;font-style:italic">precision</span> <span style="color:#ff79c6">=</span> 0.111 usec
</span></span><span style="display:flex;"><span> Jul <span style="color:#bd93f9">23</span> 13:12:11 labcentos01 ntpd<span style="color:#ff79c6">[</span>9376<span style="color:#ff79c6">]</span>: Listening on interface <span style="color:#6272a4">#0 wildcard...</span>
</span></span><span style="display:flex;"><span> Jul <span style="color:#bd93f9">23</span> 13:12:11 labcentos01 ntpd<span style="color:#ff79c6">[</span>9376<span style="color:#ff79c6">]</span>: Listening on interface <span style="color:#6272a4">#1 wildca...</span>
</span></span><span style="display:flex;"><span> Jul <span style="color:#bd93f9">23</span> 13:12:11 labcentos01 ntpd<span style="color:#ff79c6">[</span>9376<span style="color:#ff79c6">]</span>: Listening on interface <span style="color:#6272a4">#2 lo, ::1...</span>
</span></span><span style="display:flex;"><span> Jul <span style="color:#bd93f9">23</span> 13:12:11 labcentos01 ntpd<span style="color:#ff79c6">[</span>9376<span style="color:#ff79c6">]</span>: Listening on interface <span style="color:#6272a4">#3 eth0, ....</span>
</span></span><span style="display:flex;"><span> Jul <span style="color:#bd93f9">23</span> 13:12:11 labcentos01 ntpd<span style="color:#ff79c6">[</span>9376<span style="color:#ff79c6">]</span>: Listening on interface <span style="color:#6272a4">#4 lo, 127.0....</span>
</span></span></code></pre></div><ol start="5">
<li>Automatize o serviço para que inicie no boot:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo chkconfig --level <span style="color:#bd93f9">35</span> ntpd on
</span></span></code></pre></div></li>
<li>
<p>Configuração do arquivo padrão do serviço “/etc/ntp.conf”</p>
<ol>
<li>Segue o arquivo padrão fornecido pelo pacote de instalação:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># be tightened as well, but to do so would effect some of </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># the administrative functions. </span>
</span></span><span style="display:flex;"><span>   restrict 127.0.0.1 
</span></span><span style="display:flex;"><span>   restrict -6 ::1 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># Hosts on local network are less restricted. </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># Use public servers from the pool.ntp.org project. </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># Please consider joining the pool (http://www.pool.ntp.org/join.html). </span>
</span></span><span style="display:flex;"><span>   server 0.centos.pool.ntp.org iburst 
</span></span><span style="display:flex;"><span>   server 1.centos.pool.ntp.org iburst 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#broadcast 192.168.1.255 autokey        # broadcast server </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#broadcastclient                        # broadcast client </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#broadcast 224.0.1.1 autokey            # multicast server </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#multicastclient 224.0.1.1              # multicast client </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#manycastserver 239.255.254.254         # manycast server </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#manycastclient 239.255.254.254 autokey # manycast client </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># Enable public key cryptography. </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#crypto </span>
</span></span><span style="display:flex;"><span>   includefile /etc/ntp/crypto/pw 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># Key file containing the keys and key identifiers used when operating </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># with symmetric key cryptography. </span>
</span></span><span style="display:flex;"><span>   keys /etc/ntp/keys 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># Specify the key identifiers which are trusted. </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#trustedkey 4 8 42 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># Specify the key identifier to use with the ntpdc utility. </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#requestkey 8 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># Specify the key identifier to use with the ntpq utility. </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#controlkey 8 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4"># Enable writing of statistics records. </span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#statistics clockstats cryptostats loopstats peerstat</span>
</span></span></code></pre></div><ol start="2">
<li>Modifique as linhas “server”, substituindo pelo servidor NTP local; sendo uma linha para cada servidor&hellip; :
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>server 0.redhat.pool.ntp.org iburst 
</span></span><span style="display:flex;"><span>server 1.redhat.pool.ntp.org iburst 
</span></span></code></pre></div><ul>
<li>Modificando para o NTP Brasileiro ou na LAN:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>server 192.0.2.151 iburst
</span></span><span style="display:flex;"><span>ou
</span></span><span style="display:flex;"><span>server a.st1.ntp.br iburst
</span></span><span style="display:flex;"><span>ou
</span></span><span style="display:flex;"><span>server a.ntp.br iburst
</span></span></code></pre></div><ul>
<li>a flag <em>iburst</em> faz com que uma saraivada de mensagens sejam trocadas para preparar os dados e ajustar o relógio por cerca de 10s.</li>
</ul>
</li>
<li>Reinicie o serviço NTP</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo /etc/init.d/ntpd restart
</span></span></code></pre></div><ol start="4">
<li>Agora visualize como ficou o arquivo de configuração do serviço NTP:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo cat /etc/ntp.conf |grep -E -v <span style="color:#f1fa8c">&#34;^</span>$<span style="color:#f1fa8c">|^#&#34;</span> |nl 
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">1</span>  driftfile /var/lib/ntp/drift
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">2</span>  restrict default kod nomodify notrap nopeer noquery
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">3</span>  restrict -6 default kod nomodify notrap nopeer noquery
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">4</span>  restrict 127.0.0.1
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">5</span>  restrict -6 ::1
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">6</span>  server 192.0.2.151 iburst
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">7</span>  includefile /etc/ntp/crypto/pw
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">8</span>  keys /etc/ntp/keys
</span></span></code></pre></div><ol start="5">
<li>Outra opção interessante para habilitar no “ntp.conf” para a configuração cliente é a diretiva de estatísticas:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># estatisticas do ntp que exibe informaões de funcionamento.</span>
</span></span><span style="display:flex;"><span>statsdir /var/log/ntpstats/
</span></span><span style="display:flex;"><span>statistics loopstats peerstats 
</span></span><span style="display:flex;"><span>filegen loopstats file loopstats <span style="color:#8be9fd;font-style:italic">type</span> day <span style="color:#8be9fd;font-style:italic">enable</span>
</span></span><span style="display:flex;"><span>ilegen peerstats file peerstats <span style="color:#8be9fd;font-style:italic">type</span> day <span style="color:#8be9fd;font-style:italic">enable</span>
</span></span></code></pre></div></li>
<li>
<p>Verificando se o daemon NTP está devidamente configurado e operando:</p>
<ol>
<li>Execute o comando “ntpq” com a opção “-c peers” que lista estatísticas dos servidores cadastrados no arquivo /etc/ntp.conf.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ntpq -c pe** 
</span></span><span style="display:flex;"><span>ou
</span></span><span style="display:flex;"><span>$ sudo ntpq -c peers**
</span></span></code></pre></div><ul>
<li>se a resposta for algo parecido com a descrita abaixo, o daemon não está ativo</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>localhost.localdomain: timed out, nothing received
</span></span><span style="display:flex;"><span>*****Request timed out**
</span></span></code></pre></div><ul>
<li>se a resposta for próxima da descrita abaixo, o NTP está operando:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>remote        refid           st t when poll reach delay offset <span style="color:#8be9fd;font-style:italic">jitter</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==========================================================================</span>
</span></span><span style="display:flex;"><span>*192.0.2.151  200.186.125.195  <span style="color:#bd93f9">2</span> u <span style="color:#bd93f9">84</span>   <span style="color:#bd93f9">1024</span> <span style="color:#bd93f9">377</span>   0.750 0.138  0.279
</span></span></code></pre></div><ul>
<li>Segue mais um resultado de um NTP com mais de 1 servidor de horas configurado</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>remote         refid     st  t  when  poll reach  delay	offset	<span style="color:#8be9fd;font-style:italic">jitter</span> 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">=============================================================================</span> 
</span></span><span style="display:flex;"><span>+a.st1.ntp.br  .ONBR.    <span style="color:#bd93f9">1</span>   u  <span style="color:#bd93f9">8</span>     64	  <span style="color:#bd93f9">1</span>      11.929 -0.405	1.353 
</span></span><span style="display:flex;"><span>201.49.148.135  .STEP.   <span style="color:#bd93f9">16</span>  u  -     <span style="color:#bd93f9">64</span>   <span style="color:#bd93f9">0</span>      0.000  0.000 	0.000 
</span></span><span style="display:flex;"><span>*d.st1.ntp.br  .ONBR.    <span style="color:#bd93f9">1</span>   u  <span style="color:#bd93f9">4</span>     <span style="color:#bd93f9">64</span>   <span style="color:#bd93f9">1</span>      19.496 -0.530	0.392 
</span></span><span style="display:flex;"><span>-a.ntp.br  200.160.7.186 <span style="color:#bd93f9">2</span>   u  <span style="color:#bd93f9">4</span>     <span style="color:#bd93f9">64</span>   <span style="color:#bd93f9">1</span>      11.061 0.117	  1.151 
</span></span><span style="display:flex;"><span>+b.ntp.br  200.20.186.76 <span style="color:#bd93f9">2</span>   u  -     <span style="color:#bd93f9">64</span>   <span style="color:#bd93f9">1</span>      14.459 -2.561	2.544
</span></span></code></pre></div><ul>
<li><em>stratum 16 indica servidor inoperante.</em></li>
<li>Compreendendo cada campo
<ul>
<li><em>offset</em> - mostra em milissegundos o quanto a hora no servidor precisa adiantar ou se atrasar para  ficar igual a do servidor NTP  ( esses valores devem estar em milissegundos! Acima de segundos não é um bom resultado.)</li>
<li><em>delay</em> mostra o tempo que o pacote demora para ir ao servidor e voltar para o host.</li>
<li><em>jitter</em> mostra o quanto em milissegundos existe de variação nas medidas de deslocamento dos pacotes e, o quanto mais baixo melhor.</li>
<li><em>reach</em> mostra o resultado em octal das últimas 8 tentativas de conexão ao servidor preferencial de horas. O valor 	esperado é  “377” que indica que as últimas tentativas obtiveram sucesso! Valores diferentes indicam falhas  ocorridas.
<ul>
<li>Para melhor compreensão, é  um registrador de 8 bits que vai girando para a esquerda representado na forma octal, que mostra o resultado das últimas 8 consultas à fonte de tempo: 377 = 11.111.111 significa que todas as consultas foram bem sucedidas;
<ul>
<li>outros número indicam falhas, por exemplo 375 = 11.111.101, indica que a penúltima consulta falhou.</li>
</ul>
</li>
</ul>
</li>
<li><em>refid</em> mostra a referência (par do sistema) ao qual, o servidor de tempo remoto está sincronizado.</li>
<li><em>st</em> mostra o strato da fonte de tempo.</li>
<li><em>when</em> quanto segundos se passaram desde a última consulta à essa fonte de tempo.</li>
<li><em>poll</em> mostra de quantos em quantos segundos essa fonte é consultada.</li>
</ul>
</li>
</ul>
<ol start="2">
<li>Execute-o novamente com a opção “-c rv” para visualizar o estado da hora local</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ntpq -c rv
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">assID</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> <span style="color:#8be9fd;font-style:italic">status</span><span style="color:#ff79c6">=</span>46f4 leap_add_sec, sync_ntp, <span style="color:#bd93f9">15</span> events, event_peer/strat_chg,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;ntpd 4.2.4p8@1.1612-o Thu Jan 10 15:17:40 UTC 2013 (1)&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">processor</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;x86_64&#34;</span>, <span style="color:#8be9fd;font-style:italic">system</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Linux/2.6.32-279.19.1.el6.x86_64&#34;</span>, <span style="color:#8be9fd;font-style:italic">leap</span><span style="color:#ff79c6">=</span>01,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">stratum</span><span style="color:#ff79c6">=</span>3, <span style="color:#8be9fd;font-style:italic">precision</span><span style="color:#ff79c6">=</span>-24, <span style="color:#8be9fd;font-style:italic">rootdelay</span><span style="color:#ff79c6">=</span>15.668, <span style="color:#8be9fd;font-style:italic">rootdispersion</span><span style="color:#ff79c6">=</span>59.025,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">peer</span><span style="color:#ff79c6">=</span>14178, <span style="color:#8be9fd;font-style:italic">refid</span><span style="color:#ff79c6">=</span>192.0.2.151,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">reftime</span><span style="color:#ff79c6">=</span>d59b9d48.ef695513  Thu, Jul <span style="color:#bd93f9">25</span> <span style="color:#bd93f9">2013</span>  9:49:12.935, <span style="color:#8be9fd;font-style:italic">poll</span><span style="color:#ff79c6">=</span>10,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">clock</span><span style="color:#ff79c6">=</span>d59ba39e.61ba5ac8  Thu, Jul <span style="color:#bd93f9">25</span> <span style="color:#bd93f9">2013</span> 10:16:14.381, <span style="color:#8be9fd;font-style:italic">state</span><span style="color:#ff79c6">=</span>4,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">offset</span><span style="color:#ff79c6">=</span>0.073, <span style="color:#8be9fd;font-style:italic">frequency</span><span style="color:#ff79c6">=</span>7.577, <span style="color:#8be9fd;font-style:italic">jitter</span><span style="color:#ff79c6">=</span>0.051, <span style="color:#8be9fd;font-style:italic">noise</span><span style="color:#ff79c6">=</span>0.232,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">stability</span><span style="color:#ff79c6">=</span>0.018, <span style="color:#8be9fd;font-style:italic">tai</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>
</span></span></code></pre></div><ul>
<li>compreendendo os campos
<ul>
<li><em>version</em> mostra a versão do NTP e sua data e hora de construção.</li>
<li><em>processor</em> mostra a versão e plataforma do hardware.</li>
<li><em>stratum</em>  que pode ir de 1 até 15 mostra a distância que o servidor NTP usado está do o relógio de referência que transmite a hora UCT, que por sua vez está em stratum-0!
<ul>
<li>Lembrando que quanto mais próximo o servidor estiver do stratum-0, menos atraso ele terá em realação ao UCT; ou seja quanto menor a distância melhor&hellip; Variável “peer” ID associado ao servidor NTP preferencial.</li>
</ul>
</li>
<li><em>reftime</em>  mostra a data e hora que o servidor preferencial foi atualizado pela última vez pelo seu stratum superior.</li>
<li><em>clock</em> data e hora do dia! Aquele que foi setado/configurado no seu servidor host.</li>
<li><em>offset</em>  deslocamento, quanto o relógio local tem de ser adiantado ou atrasado para chegar à hora certa (horaigual à do estrato 0).</li>
<li><em>precision</em> precisão indicada com o expoente de um número base 2 Variável “rootdisperion” erro máximo da medida de offset em relação ao strato 0, em milissegundos.</li>
<li><em>rootdelay</em> atraso ou tempo de ida e volta dos pacotes atéo strato 0, em milissegundos.</li>
<li><em>refid</em> o par do sistema, ou principal referência.</li>
<li><em>frequency</em> erro na freqüência do relógio local, em relação à freqüência do estrato 0, em partes por milhão (PPM).</li>
</ul>
</li>
</ul>
<ol start="3">
<li>Obtendo informações separadamente de cada servidor NTP configurado! Essa forma é utilizada por exemplo para medir as informações de um servidor NTP secundário afim de tomar alguma decisão como a de substituir o servidor preferencial problemático por algum outro do pool&hellip;</li>
</ol>
<ul>
<li>Primeiro liste o ID dos servidores NTP configurados com o comando “ntpq -c as”:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ntpq -c as
</span></span><span style="display:flex;"><span>ou
</span></span><span style="display:flex;"><span>sudo ntpq -c associations
</span></span><span style="display:flex;"><span>ind 	assID	status  conf	reach	auth	condition	last_event	<span style="color:#8be9fd;font-style:italic">cnt</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">=====================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">1</span> 	  14178	<span style="color:#bd93f9">9614</span>    yes	  yes  	none	sys.peer	reachable	   <span style="color:#bd93f9">1</span>
</span></span></code></pre></div><ol start="4">
<li>Depois de obtido o ID obtenha as informações do servisor NTP entrando na linha de comando da ferramenta ntpq e utilize a opção “rv” seguido do ID.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ntpq  <span style="color:#ff79c6">[</span>enter<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>$ sudo ntpq&gt; rv <span style="color:#bd93f9">14178</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">assID</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">14178</span> <span style="color:#8be9fd;font-style:italic">status</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">9614</span> reach, conf, sel_sys.peer, <span style="color:#bd93f9">1</span> event, event_reach,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">srcadr</span><span style="color:#ff79c6">=</span>192.0.2.151, <span style="color:#8be9fd;font-style:italic">srcport</span><span style="color:#ff79c6">=</span>123, <span style="color:#8be9fd;font-style:italic">dstadr</span><span style="color:#ff79c6">=</span>192.0.2.140, <span style="color:#8be9fd;font-style:italic">dstport</span><span style="color:#ff79c6">=</span>123,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">leap</span><span style="color:#ff79c6">=</span>00, <span style="color:#8be9fd;font-style:italic">stratum</span><span style="color:#ff79c6">=</span>2, <span style="color:#8be9fd;font-style:italic">precision</span><span style="color:#ff79c6">=</span>-23, <span style="color:#8be9fd;font-style:italic">rootdelay</span><span style="color:#ff79c6">=</span>16.342,rootdispersion<span style="color:#ff79c6">=</span>16.281, 
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">refid</span><span style="color:#ff79c6">=</span>200.186.125.195, <span style="color:#8be9fd;font-style:italic">reach</span><span style="color:#ff79c6">=</span>377, <span style="color:#8be9fd;font-style:italic">unreach</span><span style="color:#ff79c6">=</span>0,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">hmode</span><span style="color:#ff79c6">=</span>3, <span style="color:#8be9fd;font-style:italic">pmode</span><span style="color:#ff79c6">=</span>4, <span style="color:#8be9fd;font-style:italic">hpoll</span><span style="color:#ff79c6">=</span>10, <span style="color:#8be9fd;font-style:italic">ppoll</span><span style="color:#ff79c6">=</span>10, <span style="color:#8be9fd;font-style:italic">flash</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">00</span> ok, <span style="color:#8be9fd;font-style:italic">keyid</span><span style="color:#ff79c6">=</span>0, <span style="color:#8be9fd;font-style:italic">ttl</span><span style="color:#ff79c6">=</span>0,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">offset</span><span style="color:#ff79c6">=</span>0.345, <span style="color:#8be9fd;font-style:italic">delay</span><span style="color:#ff79c6">=</span>1.032, <span style="color:#8be9fd;font-style:italic">dispersion</span><span style="color:#ff79c6">=</span>14.833, <span style="color:#8be9fd;font-style:italic">jitter</span><span style="color:#ff79c6">=</span>0.124,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">reftime</span><span style="color:#ff79c6">=</span>d59c0533.3051b8eb  Thu, Jul <span style="color:#bd93f9">25</span> <span style="color:#bd93f9">2013</span> 17:12:35.188,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">org</span><span style="color:#ff79c6">=</span>d59c0552.e99941c5  Thu, Jul <span style="color:#bd93f9">25</span> <span style="color:#bd93f9">2013</span> 17:13:06.912,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">rec</span><span style="color:#ff79c6">=</span>d59c0552.e9a47a2b  Thu, Jul <span style="color:#bd93f9">25</span> <span style="color:#bd93f9">2013</span> 17:13:06.912,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">xmt</span><span style="color:#ff79c6">=</span>d59c0552.e95ea055  Thu, Jul <span style="color:#bd93f9">25</span> <span style="color:#bd93f9">2013</span> 17:13:06.911,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">filtdelay</span><span style="color:#ff79c6">=</span>     1.03    1.12    1.22    1.10    0.64    1.30    1.57    1.09,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">filtoffset</span><span style="color:#ff79c6">=</span>    0.34    0.22    0.00   -0.01    0.16   -0.41   -0.41   -0.32,
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">filtdisp</span><span style="color:#ff79c6">=</span>      0.00   15.38   30.75   46.11   61.50   76.85   92.22  107.58
</span></span></code></pre></div></li>
<li>
<p>Caso precise gerar alguma evidência para documentação, etc&hellip; É possível gerar gráficos utilizando os logs de estatísticas  do diretório “/var/log/ntpstats”, que são:</p>
</li>
</ol>
<ul>
<li><em>loopstats</em>, que apresenta as informações do loop local, ou seja, as variáveis do sistema.</li>
<li>formato</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#bd93f9">54475</span> 73467.286 -0.000057852 31.695 0.000015298 0.006470 <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">54475</span> 73548.286 -0.000084064 31.688 0.000017049 0.006471 <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">54475</span> 73682.286 -0.000077221 31.678 0.000016130 0.006988 <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">54475</span> 73698.286 -0.000077448 31.677 0.000015103 0.006550 <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">54475</span> 73761.286 -0.000083230 31.672 0.000014275 0.006376 <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">54475</span> 73889.286 -0.000059100 31.665 0.000015846 0.006487 <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">54475</span> 74004.285 -0.000045825 31.660 0.000015548 0.006324 <span style="color:#bd93f9">4</span>
</span></span></code></pre></div><pre><code>-  campos:
     - coluna 1: day
     - coluna 2: second
     - coluna 3: offset
     - coluna 4: drift compensation
     - coluna 5: estimed error
     - coluna 6: stability
     - coluna 7: polling interval
</code></pre>
<ul>
<li><em>peerstats</em> que apresenta as informações de cada associação</li>
<li>formato</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#bd93f9">54475</span> 34931.294 200.20.186.75 <span style="color:#bd93f9">9074</span> 0.009958844 0.008390600 0.000390895 0.000132755
</span></span><span style="display:flex;"><span> <span style="color:#bd93f9">54475</span> 34931.301 200.192.232.43 f0f4 0.000348814 0.015550265 0.001120348 0.000023645
</span></span><span style="display:flex;"><span> <span style="color:#bd93f9">54475</span> 34932.303 200.189.40.28 f0f4 0.000810708 0.017701986 0.188995109 0.000043145
</span></span><span style="display:flex;"><span> <span style="color:#bd93f9">54475</span> 34934.286 200.160.0.28 f0d4 0.000332344 0.000271801 0.000620139 0.000037467
</span></span><span style="display:flex;"><span> <span style="color:#bd93f9">54475</span> 34935.286 200.160.7.165 <span style="color:#bd93f9">9614</span> 0.000003557 0.000216088 0.000826694 0.000022076
</span></span></code></pre></div><pre><code> - campos
	 - coluna 1: day
	 - coluna 2: second
	 - coluna 3: address
	 - coluna 4: status
	 - coluna 5: offset
	 - coluna 6: delay
	 - coluna 7: dispersion
	 - coluna 8: skew/variance
</code></pre>
<ul>
<li>Além de poder ser usado para documentação, também fica mais fácil a leitura com o gráfico para ilustrá-lo. Excell pode ser usado&hellip;
<ul>
<li>Mas porque não usar terminal e <a href="http://www.gnuplot.info">gnuplot</a> :).
<ul>
<li>segue algumas referências: <a href="https://developer.ibm.com/tutorials/ba-cleanse-process-visualize-data-set-3/?mhsrc=ibmsearch_a&amp;mhq=gnuplot">IBM</a></li>
</ul>
</li>
<li>Segue um exemplo de uso:
<ul>
<li>Crie um arquivo texto com um nome pretendido, com o seguinte conteúdo:</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#f1fa8c">&lt;&lt;Fin&gt; /tmp/deslocamento.txt
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">set term gifset output &#39;Deslocamento.png&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">set title &#34;Deslocamento&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">plot &#34;/var/log/ntpstats/loopstats&#34; using 2:3 t&#34;deslocamento&#34; with linespoints lt rgb &#34;#d82886&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">Fin</span>
</span></span></code></pre></div><ul>
<li>Estamos referenciando o arquivo loopstats e, fazendo uso das colunas 2 e 3! A coluna 2 indica o tempo, no dia, em segundos; e a coluna 3 indica o deslocamento, em milissegundos. Também estamos utilizando cores RGB declarada em <a href="http://www.colorhexa.com">hexadecimal</a>.
<ul>
<li>Agora geramos o gráfico</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gnuplot /tmp/deslocamento.txt
</span></span></code></pre></div></li>
</ul>
<p><img src="/static/images/NTP/deslocamento.png" alt="deslocamento.png"></p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>RTFM &amp; Aleatoriedades para SysAdmin - journalctl </title>
      <link>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-journalctl/</link>
      <pubDate>Fri, 05 Jan 2024 17:43:55 -0300</pubDate>
      
      <guid>https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadmin-journalctl/</guid>
      <description><![CDATA[<p>Para quando a lei de Murphy exerce a sua força. É nessa hora, que do seu kit MacGyver, você tira o <strong>journalctl</strong>  para identificar o que pode estar errado!</p>
<p>Das muitas formas possíveis. Tem mais essa:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ journalctl --no-pager --since today --grep <span style="color:#f1fa8c">&#39;fail|error|fatal&#39;</span> --output json|jq
</span></span></code></pre></div><ul>
<li>Com a opção &ldquo;&ndash;grep&rdquo; filtramos palavras chave</li>
<li>Com a opção &ldquo;&ndash;since&rdquo; melhoramos nossa assertividade.
<ul>
<li>Ex:
<ul>
<li>&ndash;since &ldquo;1 hour ago&rdquo;</li>
<li>&ndash;since &ldquo;1 minutes ago&rdquo;</li>
<li>&ndash;since &ldquo;5 seconds ago&rdquo;</li>
<li>&ndash;since 07:00 &ndash;until &ldquo;1 hour ago&rdquo;</li>
</ul>
</li>
</ul>
</li>
<li>Com o &ldquo;&ndash;output&rdquo; usando o formato <em>json</em>, fazemos um parser amigável pra organizarmos com <strong>jq</strong>.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ journalctl --no-pager --since today --grep <span style="color:#f1fa8c">&#39;fail|error|fatal&#39;</span> --output json|jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_PID&#34;</span>: <span style="color:#f1fa8c">&#34;5605&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_SYSTEMD_SLICE&#34;</span>: <span style="color:#f1fa8c">&#34;user-1000.slice&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_SYSTEMD_USER_UNIT&#34;</span>: <span style="color:#f1fa8c">&#34;org.gnome.Shell@wayland.service&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_RUNTIME_SCOPE&#34;</span>: <span style="color:#f1fa8c">&#34;system&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_SYSTEMD_UNIT&#34;</span>: <span style="color:#f1fa8c">&#34;user@1000.service&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;__SEQNUM&#34;</span>: <span style="color:#f1fa8c">&#34;7540847&#34;</span>,
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_SYSTEMD_OWNER_UID&#34;</span>: <span style="color:#f1fa8c">&#34;1000&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;SYSLOG_IDENTIFIER&#34;</span>: <span style="color:#f1fa8c">&#34;google-chrome.desktop&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_COMM&#34;</span>: <span style="color:#f1fa8c">&#34;cat&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;__MONOTONIC_TIMESTAMP&#34;</span>: <span style="color:#f1fa8c">&#34;285995139402&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_CMDLINE&#34;</span>: <span style="color:#f1fa8c">&#34;cat&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_BOOT_ID&#34;</span>: <span style="color:#f1fa8c">&#34;da45ccab9c404e9444444a9c51300cae&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#34;_EXE&#34;</span>: <span style="color:#f1fa8c">&#34;/usr/bin/cat&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Ainda é possível filtrar por algum objeto com o <em>jq</em> e quantificar as ocorrências com sort e uniq</p>
<ul>
<li>Talvez, alguns objetos interessantes seriam _EXE, _CMDLINE, _PID, SYSLOG_IDENTIFIER, MESSAGE&hellip;</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ journalctl --no-pager --since <span style="color:#f1fa8c">&#34;60 minutes ago&#34;</span> --grep <span style="color:#f1fa8c">&#39;fail|error|fatal&#39;</span> --output json|jq <span style="color:#f1fa8c">&#39;.SYSLOG_IDENTIFIER&#39;</span> | sort | uniq -c
</span></span><span style="display:flex;"><span>      <span style="color:#bd93f9">1</span> <span style="color:#f1fa8c">&#34;audit&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#bd93f9">1</span> <span style="color:#f1fa8c">&#34;cupsd&#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#bd93f9">19</span> <span style="color:#f1fa8c">&#34;discord.desktop&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#bd93f9">2</span> <span style="color:#f1fa8c">&#34;fprintd&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#bd93f9">7</span> <span style="color:#f1fa8c">&#34;gnome-shell&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#bd93f9">10518</span> <span style="color:#f1fa8c">&#34;google-chrome.desktop&#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#bd93f9">18</span> null
</span></span><span style="display:flex;"><span>      <span style="color:#bd93f9">4</span> <span style="color:#f1fa8c">&#34;org.gnome.Software.desktop&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">173</span> <span style="color:#f1fa8c">&#34;slack.desktop&#34;</span>
</span></span></code></pre></div>]]></description>
      
    </item>
    
    
  </channel>
</rss>
