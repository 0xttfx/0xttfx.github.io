<!DOCTYPE html>
<html class="" lang="en"><head>
    
    <meta name="robots" content="noai, noimageai">
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

<title>
        
            RTFM &amp; Aleatoriedades para SysAdmin, SecOps, DevOps, {SN}RE - Firewall  &ndash;
        
        0xttfx
    </title>

    
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="/>
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="/>

    
    
    <link type="text/css" rel="stylesheet" href=https://0xttfx.github.io/css/styles.abbd6311bb4b6ca58f8e7398140529245ae0f6428b759fcd830742eee2619eabb900ba9914a9affb82aa9a16a9b9ea727bb315315a976a0db0e7513a5f12c504.css integrity="sha512-q71jEbtLbKWPjnOYFAUpJFrg9kKLdZ/NgwdC7uJhnqu5ALqZFKmv&#43;4Kqmhapuepye7MVMVqXag2w51E6XxLFBA==" />
<meta name="author" content="Thiago T Faioli" />

    
        <meta name="keywords" content='DDoS, DoS, Firewall, OpenBSD, PF, SegInfo' />
    
    
        <meta name="description" content="Requisitos mínimos para um firewall tecnicamente descente e profissional." />
    

<meta property="og:site_name"
    content='0xttfx' />

    <meta property="og:title" content="RTFM &amp; Aleatoriedades para SysAdmin, SecOps, DevOps, {SN}RE - Firewall" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="Thiago T Faioli" />
    <meta
        property="article:published_time"
        content='2024-11-12T18:07:52Z-0300' />
    
        
            <meta property="article:tag" content="DDoS" />
        
            <meta property="article:tag" content="DoS" />
        
            <meta property="article:tag" content="Firewall" />
        
            <meta property="article:tag" content="OpenBSD" />
        
            <meta property="article:tag" content="PF" />
        
            <meta property="article:tag" content="SegInfo" />
        
    
    <meta property="og:url" content="https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadminsecopsdevopssnre-firewall/" />
    
    
    <meta property="og:image"
        content="https://0xttfx.github.io/img/icon.svg" />
    
        <meta property="og:description" content="Requisitos mínimos para um firewall tecnicamente descente e profissional." />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='0xttfx.github.io'
/>
<meta property="twitter:url" content="https://0xttfx.github.io/posts/rtfmaleatoriedadesparasysadminsecopsdevopssnre-firewall/" />


    <meta name="twitter:title" content="RTFM &amp; Aleatoriedades para SysAdmin, SecOps, DevOps, {SN}RE - Firewall" />
    
    
    
    <meta name="twitter:image"
        content="https://0xttfx.github.io/img/icon.svg" />
    
        <meta name="twitter:description" content="Requisitos mínimos para um firewall tecnicamente descente e profissional." />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">0xttfx</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts/">Posts</a></li>
        
        
        
        
        
            <li><a href="https://0xttfx.github.io/pages/about/">
                About
            </a></li>
        
        
        
            <li><a href="/tags/">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <span class="nerdlink" onclick="newSearch();">&#xf002;</span>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search/?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="/index.xml">
    
    
        &#xf09e;
    
    <span>
        RSS
    </span>
</a>

        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://discord.gg/jMztSAgJ">
    
    
        &#xfb6e;
    
    <span>
        Discord
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="thiago.faioli@bsd.com.br">
    
    
        &#xf6ed;
    
    <span>
        Email
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/0xttfx">
    
    
        &#xf09b;
    
    <span>
        GitHub
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://instagram.com/0xttfx">
    
    
        &#xf16d;
    
    <span>
        Instagram
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://linkedin.com/in/thiagofaioli">
    
    
        &#xf0e1;
    
    <span>
        Linkedin
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://t.me/0xttfx">
    
    
        &#xf2c6;
    
    <span>
        Telegram
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://twitter.com/0xttfx">
    
    
        &#xf099;
    
    <span>
        X
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>RTFM &amp; Aleatoriedades para SysAdmin, SecOps, DevOps, {SN}RE - Firewall</h1>
    
    
        <p class="date">
            <span title='Date'> </span>
    2024-11-12

</p>
    
    
    
    
    <div><h1 id="firewall-policy">Firewall Policy</h1>
<p>Em 2016 eu fiz participei do curso <a href="https://www.freebsdbrasil.com.br/treinamento/treinamentos-ssa.html">FreeBSD S.S.A</a> na <a href="https://www.freebsdbrasil.com.br">FreeBSD brasil</a> que sem sombra de dúvidas foi um dos <strong>raros treinamentos</strong> que de fato entregou conhecimento e me fez avançar de diversas formas no gerenciamento de redes, roteamento e segurança complexos de forma KISS.</p>
<blockquote>
<p>[!TIP]
SSA - Server and System Systems Administration
December 2016
FreeBSD Brasil LTDA
<a href="https://www.freebsdbrasil.com.br/treinamento/certificacao-validar-certificados.html">Certificado Número: 011245</a></p>
</blockquote>
<p>Como reflexo reflexo do conhecimento adquirido. A atenção aos requisitos mínimos, necessários para conceber um firewall tecnicamente descente e profissional: tornaram-se mandatórios! E por isso, segue como sugestão, uma lista mandatória de requisitos mínimos que precisam ser atendidos:</p>
<ul>
<li>tratar tráfego loopback e pseudo interfaces,</li>
<li>tratar anomalias IP e por protocolo,</li>
<li>criar limites de fluxo IP,</li>
<li>tratar transformações e validações de pacotes,</li>
<li>criar políticas por protocolo, serviço, host e redes,</li>
<li>aplicar técnicas para mitigar DoS e DDoS,</li>
<li>considerar o esgotamento de recursos computacionais.</li>
<li>estar alinhado às diretrizes do &ldquo;NIST SP 800-41 Revision 1 - Guidelines on Firewalls and Firewall Policy&rdquo;.</li>
</ul>
<blockquote>
<p>[!NOTE]
Ambiente de teste:</p>
<ul>
<li>Aplicações
<ul>
<li>httpd daemon,</li>
<li>OpenSSH,</li>
<li>Wireguard,</li>
<li>Prometheus Node Exporter,</li>
<li>Tor relay obfs4 bridge.</li>
</ul>
</li>
<li>servidor
<ul>
<li>VPS <a href="https://www.vultr.com">VULTR</a>
<ul>
<li>Regular Cloud Compute.</li>
<li>1 vCPU, 1024 MB RAM, 25 GB SSD, 1.00 TB Transfer.</li>
<li>OpenBSD 7.4 (GENERIC.MP) #1396: Sun Oct 8 09:20:40 MDT 2023.</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="ruleset">Ruleset</h3>
<p>Segue abaixo, uma  sugestão de conjunto de regras de firewall  <a href="https://www.openbsd.org"><em>Open</em><strong>BSD</strong></a> PF - Packet Filtering.</p>
<ul>
<li>/etc/pf.conf</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># Definições de interfaces</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ext_if</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;vio0&#34;</span>            <span style="color:#6272a4"># Interface externa (WAN)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">int_if</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;vio1&#34;</span>            <span style="color:#6272a4"># Interface interna (LAN)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">lo_if</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;lo0&#34;</span>       <span style="color:#6272a4"># Interface loopback</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">wg_if</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;wg0&#34;</span>             <span style="color:#6272a4"># Interface VPN WireGuard</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Endereços IP e redes</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">server_ip</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;215.230.100.124&#34;</span>  <span style="color:#6272a4"># IP do servidor de aplicação</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">lan_net</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;10.42.95.0/20&#34;</span>   <span style="color:#6272a4"># Rede interna (LAN)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">vpn_net</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;10.0.0.0/24&#34;</span>      <span style="color:#6272a4"># Rede da VPN WireGuard</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">srv_monit_ip</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;0.0.0.0&#34;</span><span style="color:#6272a4"># IP do servidor de monitoramento</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Portas Permitidas (HTTP, HTTPS, SSH, WireGuard, Prometheus)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">allowed_ports_tcp</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;{ 22, 80, 443, 9100, 51820, 9001, 9003 }&#34;</span>  <span style="color:#6272a4"># 51820 é a porta padrão do WireGuard</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">allowed_ports_udp</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;{ domain }&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ICMP</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://man.openbsd.org/icmp</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">icmp_types</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;{ echoreq, unreach, timex, trace }&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">non_routable</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8, 169.254.0.0/16, 192.0.2.0/24, 0.0.0.0/8, 240.0.0.0/4 }&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># LOG</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">pflog_logfile</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;/var/log/pflog&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Criando tabelas</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/tables.html</span>
</span></span><span style="display:flex;"><span>table &lt;trusted_admins&gt; persist file <span style="color:#f1fa8c">&#34;/etc/trusted_admins&#34;</span>
</span></span><span style="display:flex;"><span>table &lt;blocked_hosts&gt; persist
</span></span><span style="display:flex;"><span>table &lt;blocked_bforce&gt; persist
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Política de Bloqueio Padrão e de Limites de Estado e Fragmentação</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Bloqueio de todo o tráfego por padrão, com permissões específicas para tráfego necessário.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/options.html</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Política de segurança mínima - &#34;deny all&#34;. Alinhado com o NIST SP 800-41 Revision 1, Seção 4 - Firewall Policy </span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">set</span> block-policy drop        <span style="color:#6272a4"># Define o comportamento padrão para regras de filtro: drop - packet is silently dropped</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">set</span> loginterface <span style="color:#8be9fd;font-style:italic">$ext_if</span>     <span style="color:#6272a4"># Loga tráfego na interface externa para auditoria</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">set</span> skip on <span style="color:#8be9fd;font-style:italic">$lo_if</span>           <span style="color:#6272a4"># Ignora tráfego na interface loopback para desempenho</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Limita o número de estados de conexão e fragmentos permitidos para prevenir ataques DoS.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># NIST SP 800-41, Seção 4.4 - Policies Based on Network Activity</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/options.html</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Estabelendo limites na operação do Pf. Configurações atuais: `pfctl -s memory`.</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">set</span> limit <span style="color:#ff79c6">{</span> states 10000, frags <span style="color:#bd93f9">5000</span> <span style="color:#ff79c6">}</span>  <span style="color:#6272a4"># frags - número máximo de entradas no pool de memória usado para remontagem de pacotes (scrub rules). O padrão é de 5000. states - número máximo de entradas no pool de memória usado para entradas de tabela de estado (regras de filtro que especificam o keep state). O padrão é 100000.</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">set</span> optimization normal  <span style="color:#6272a4"># Configuração otimizada para tráfego em ambiente de rede: normal - adequado para quase todas as redes.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhado com a prática de &#34;deny-all&#34; na entrada e saída: exceto o permitido explicitamente.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/tagging.html#policy</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#defdeny</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Conforme NIST SP 800-41, Seção 4.1 (Política padrão de bloqueio)</span>
</span></span><span style="display:flex;"><span>block in log all  <span style="color:#6272a4"># bloqueará o tráfego de entrada em todas as interfaces em qualquer direção de qualquer lugar para qualquer lugar.</span>
</span></span><span style="display:flex;"><span>block out log all <span style="color:#6272a4"># bloqueará o tráfego de saida em todas as interfaces em qualquer direção de qualquer lugar para qualquer lugar.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Prevenção de Anomalias IP</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Previne spoofing e anomalias de IP usando a diretiva `antispoof`.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#antispoof</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Conforme NIST SP 800-41, seção 4.1.1 - IP Addresses and Other IP Characteristics</span>
</span></span><span style="display:flex;"><span>antispoof quick <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">{</span> <span style="color:#8be9fd;font-style:italic">$ext_if</span> <span style="color:#8be9fd;font-style:italic">$int_if</span> <span style="color:#8be9fd;font-style:italic">$wg_if</span> <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Bloqueio de endereços IP não roteáveis.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Conforme NIST SP 800-41, Seção 4.1.1 - IP Addresses and Other IP Characteristics</span>
</span></span><span style="display:flex;"><span>block drop in quick on <span style="color:#8be9fd;font-style:italic">$ext_if</span> from any to <span style="color:#8be9fd;font-style:italic">$non_routable</span>    <span style="color:#6272a4"># Bloqueia loopback na interface externa</span>
</span></span><span style="display:flex;"><span>block drop in quick on <span style="color:#8be9fd;font-style:italic">$ext_if</span> from any to 255.255.255.255  <span style="color:#6272a4"># Bloqueia broadcast global</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Loopback e Pseudo-Interfaces. Permitindo tráfego local na interface loopback para evitar tretas.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhamento com NIST SP 800-41, Seção 4.1 - Policies Based on IP Addresses and Protocols</span>
</span></span><span style="display:flex;"><span>pass quick on <span style="color:#8be9fd;font-style:italic">$lo_if</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Validação e Transformação de Pacotes (scrubbing)</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Reassembla pacotes fragmentados e randomiza IDs de pacotes para prevenir ataques que exploram fragmentação.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://home.nuug.no/~peter/pf/en/scrub.html</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://man.openbsd.org/pf.conf.5#TRAFFIC_NORMALnoISATION</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://man.openbsd.org/pf.conf#match</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhamento com NIST SP 800-41, seção 2.1.1 - Packet Filtering </span>
</span></span><span style="display:flex;"><span>match in all scrub <span style="color:#ff79c6">(</span>no-df max-mss 1440<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>match out all scrub <span style="color:#ff79c6">(</span>random-id<span style="color:#ff79c6">)</span> <span style="color:#6272a4"># randomização de IDs para dificultar fingerprinting de pacotes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Permissão explícita para serviços</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#stateopts</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhamento com NIST SP 800-41, seção 4.2 - Policies Based on Applications e 2.1.1 - Packet Filtering</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#stateopts</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#synproxy</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># bloqueando sources suspeitos</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/tables.html</span>
</span></span><span style="display:flex;"><span>block in quick from &lt;blocked_hosts&gt; to any
</span></span><span style="display:flex;"><span>block in quick from &lt;blocked_bforce&gt; to any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Limitar o tráfego ICMP</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhamento com NIST SP 800-41, seção 4.1.4 - ICMP e 4.1.2 IPv6 e 4.4 - Policies Based on Network Activity</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># se os pacotes exceder 1000 por 10s, pacotes adicionais não serão processados bem como se houver mais de 1000 entradas de estados. E também, se existir mais de 100 IPs exclusivos, ou se um único IP tiver mais de 100 entradas...</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ICMP para IPv4</span>
</span></span><span style="display:flex;"><span>pass in log on <span style="color:#8be9fd;font-style:italic">$ext_if</span> inet proto icmp all from any to <span style="color:#8be9fd;font-style:italic">$ext_if</span> icmp-type <span style="color:#8be9fd;font-style:italic">$icmp_types</span> max-pkt-rate 1000/10 keep state <span style="color:#ff79c6">(</span>max 1000, source-track rule, max-src-nodes 100, max-src-states 100<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ICMPv6 para IPv6</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#pass in log on $ext_if inet proto icmp all from any to $ext_if inet6 proto icmp6 max-pkt-rate 1000/10 keep state (max 1000, source-track rule, max-src-nodes 100, max-src-states 100)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># &#34;synproxy&#34; para proteger contra ataques SYN Flood ao validar pacotes antes de enviar ao servidor.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhamento com NIST SP 800-41, seção 4.2 - Policies Based on Applications e 4.4 Policies Based on Network Activity e 4.1.3 TCP and UDP</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#stateopts</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#synproxy</span>
</span></span><span style="display:flex;"><span>pass in log on <span style="color:#8be9fd;font-style:italic">$ext_if</span> proto tcp from any to <span style="color:#8be9fd;font-style:italic">$ext_if</span> port <span style="color:#bd93f9">80</span> flags S/SA synproxy state <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">(</span>max-src-conn 10, max-src-conn-rate 10/5, <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     overload &lt;blocked_hosts&gt; flush<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># &#34;synproxy&#34; para proteger contra ataques SYN Flood ao validar pacotes antes de enviar ao servidor.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhamento com NIST SP 800-41, seção 4.2 - Policies Based on Applications e 4.4 Policies Based on Network Activity e 4.1.3 TCP and UDP</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#stateopts</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#synproxy</span>
</span></span><span style="display:flex;"><span>pass in log on <span style="color:#8be9fd;font-style:italic">$ext_if</span> proto tcp from any to <span style="color:#8be9fd;font-style:italic">$ext_if</span> port <span style="color:#bd93f9">443</span> flags S/SA synproxy state <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">(</span>max-src-conn 10, max-src-conn-rate 10/5, <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    overload &lt;blocked_hosts&gt; flush<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Limite de conexões para evitar ataques de brute force</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhamento com NIST SP 800-41, seção 4.2 - Policies Based on Applications e 4.4 Policies Based on Network Activity e 4.1.3 TCP and UDP</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#stateopts</span>
</span></span><span style="display:flex;"><span>pass in log on <span style="color:#8be9fd;font-style:italic">$ext_if</span> proto tcp from any to <span style="color:#8be9fd;font-style:italic">$ext_if</span> port <span style="color:#bd93f9">22</span> keep state <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">(</span>max-src-conn 5, max-src-conn-rate 3/10, <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     overload &lt;brute_force&gt; flush global<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Node Exporter porta 9100.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Limite de conexões para evitar ataques de brute force</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhamento com NIST SP 800-41, seção 4.2 - Policies Based on Applications e 4.4 Policies Based on Network Activity e 4.1.3 TCP and UDP</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/filter.html#stateopts</span>
</span></span><span style="display:flex;"><span>pass in log on <span style="color:#8be9fd;font-style:italic">$ext_if</span> proto tcp from any to <span style="color:#8be9fd;font-style:italic">$ext_if</span> port <span style="color:#bd93f9">9100</span> keep state <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    <span style="color:#ff79c6">(</span>max-src-conn 5, max-src-conn-rate 5/5, <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     overload &lt;blocked_bforce&gt; flush<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Tor relay obfs4 bridge</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Permite o serviço Tor nas portas 9001 e 9003.</span>
</span></span><span style="display:flex;"><span>pass in on <span style="color:#8be9fd;font-style:italic">$ext_if</span> proto tcp from any to <span style="color:#8be9fd;font-style:italic">$ext_if_ip</span> port <span style="color:#ff79c6">{</span>9001, 9003<span style="color:#ff79c6">}</span> keep state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Permissão de tráfego de saída apenas para serviços essenciais.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhado com o NIST SP 800-41, seção 4.1.1 - IP Addresses and Other IP Characteristics 4.2 - Policies Based on Applications e 4.4 Policies Based on Network Activity e 4.1.3 TCP and UDP</span>
</span></span><span style="display:flex;"><span>pass out quick on <span style="color:#8be9fd;font-style:italic">$ext_if</span> proto tcp from <span style="color:#8be9fd;font-style:italic">$server_ip</span> to any port <span style="color:#8be9fd;font-style:italic">$allowed_ports_tcp</span> keep state
</span></span><span style="display:flex;"><span>pass out quick on <span style="color:#8be9fd;font-style:italic">$ext_if</span> proto udp from <span style="color:#8be9fd;font-style:italic">$server_ip</span> to any port <span style="color:#bd93f9">51820</span> keep state  <span style="color:#6272a4"># Saída para WireGuard VPN</span>
</span></span><span style="display:flex;"><span>pass out quick on <span style="color:#8be9fd;font-style:italic">$ext_if</span> proto <span style="color:#ff79c6">{</span> tcp udp <span style="color:#ff79c6">}</span> from <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">$ext_if</span><span style="color:#ff79c6">)</span> to any port <span style="color:#bd93f9">53</span> <span style="color:#6272a4"># dns resolver </span>
</span></span><span style="display:flex;"><span>pass out quick on <span style="color:#8be9fd;font-style:italic">$ext_if</span> inet proto icmp all icmp-type <span style="color:#8be9fd;font-style:italic">$icmp_types</span> <span style="color:#6272a4"># icmp prove </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Políticas para redes</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Define permissões e restrições para a rede interna e a rede externa (WAN).</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Alinhado com o NIST SP 800-41, 4.1 Policies Based on IP Addresses and Protocols</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Tráfego permitido entre a rede interna (LAN) e o servidor.</span>
</span></span><span style="display:flex;"><span>pass in quick on <span style="color:#8be9fd;font-style:italic">$int_if</span> from <span style="color:#8be9fd;font-style:italic">$lan_net</span> to any keep state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Bloqueio de tráfego desnecessário da WAN.</span>
</span></span><span style="display:flex;"><span>block in on <span style="color:#8be9fd;font-style:italic">$ext_if</span> from any to <span style="color:#8be9fd;font-style:italic">$lan_net</span>
</span></span><span style="display:flex;"><span>block out on <span style="color:#8be9fd;font-style:italic">$ext_if</span> from <span style="color:#8be9fd;font-style:italic">$lan_net</span> to any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Monitoramento e Auditoria</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://man.openbsd.org/pflog.4</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://www.openbsd.org/faq/pf/logging.html</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># https://man.openbsd.org/pf.conf#match</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Log de tráfego relevante para auditoria e detecção de incidentes, conforme recomendado pelo NIST SP 800-41, Seção 5.</span>
</span></span><span style="display:flex;"><span>match log <span style="color:#ff79c6">(</span>all<span style="color:#ff79c6">)</span> on <span style="color:#8be9fd;font-style:italic">$ext_if</span>
</span></span></code></pre></div><h3 id="nist-special-publications">NIST Special Publications</h3>
<p>Estou usando como referência principal, a coleção de recomendações do guia <a href="https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-41r1.pdf">Special Publication 800-41 Revision 1 - Guidelines on Firewalls and Firewall Policy</a> da subsérie de especificações técnicas <a href="https://csrc.nist.gov/publications/sp800">SP 800 - Computer security</a> da  <a href="https://csrc.nist.gov/publications/sp"><strong>NIST Special Publications</strong></a></p>
<p>O conjunto de regras, tenta estar alinhado de acordo com as recomendações, parar garantir as melhores práticas para a segurança e controle de tráfego em um firewall PF em um servidor OpenBSD. E apesar de nem sempre existir uma seção do documento que faz referência direta ao método que está sendo aplicado em uma regra específica; ainda assim, eu tento sinalizar as seções que tratam de forma concreta ou abstrata&hellip; ;)</p>
<p>Por fim, conseguimos atender tecnicamente os seguintes pontos:</p>
<ul>
<li>Política de Bloqueio Padrão e Defesa em Profundidade
<ul>
<li>Todas as conexões de entrada e saída são bloqueadas por padrão para aplicar uma política de segurança mínima e alinhada ao conceito de &ldquo;defesa em profundidade&rdquo;. O NIST recomenda permitir tráfego apenas quando explicitamente autorizado.</li>
</ul>
</li>
<li>Limites de Conexão e Fragmentação
<ul>
<li>Os limites de <code>states</code> e <code>frags</code> são configurados para evitar ataques DoS e DDoS, prevenindo o esgotamento de recursos no firewall e alinhando-se com o NIST sobre restrições de uso de estados.</li>
</ul>
</li>
<li>Regras de Normalização e Scrubbing
<ul>
<li>A regra <code>scrub</code> assegura a reconstrução de pacotes fragmentados e previne anomalias de tráfego, alinhando-se com as recomendações do NIST sobre validação de pacotes.</li>
</ul>
</li>
<li>Prevenção de spoofing, syn flood e integridade de pacotes
<ul>
<li>O comando <code>antispoof</code> ajuda a bloquear pacotes forjados provenientes de IPs internos e <code>synproxy</code> evitando DoS syn flood  conforme o NIST recomenda a integridade de pacotes.</li>
</ul>
</li>
<li>Tráfego loopback
<ul>
<li>O tráfego loopback é permitido para garantir a comunicação interna do sistema, seguindo as diretrizes do NIST sobre a configuração de interfaces locais.</li>
</ul>
</li>
<li>Regras específicas por aplicação
<ul>
<li>Para SSH, HTTP/HTTPS, WireGuard, Prometheus e Tor, cada serviço possui regras de passagem individualizadas. O NIST recomenda políticas por serviço para controlar o tráfego conforme as necessidades do aplicativo. Cada regra possui limitação de taxa de conexões para prevenir ataques de força bruta e DoS.</li>
</ul>
</li>
<li>Limitação de conexões ICMP
<ul>
<li>Limita o número de requisições ICMP permitidas por host, ajudando a mitigar possíveis abusos e ataques de DoS via ICMP. A configuração separa IPv4 e IPv6 para garantir a compatibilidade.</li>
</ul>
</li>
<li>Controle e auditoria de tráfego com log
<ul>
<li>O <code>match log (all)</code> permite auditoria completa do tráfego de entrada e saída, alinhado ao NIST, que recomenda manter registros de incidentes para análise e conformidade.</li>
</ul>
</li>
</ul>
</div>
</article>

    <hr />
    <p class="articleTagsContainer">
        <span> </span>
        <strong>Tags:</strong>
        
            <a
                
                href="/tags/ddos/">#DDoS</a>
        
            <a
                
                href="/tags/dos/">#DoS</a>
        
            <a
                
                href="/tags/firewall/">#Firewall</a>
        
            <a
                
                href="/tags/openbsd/">#OpenBSD</a>
        
            <a
                
                href="/tags/pf/">#PF</a>
        
            <a
                
                href="/tags/seginfo/">#SegInfo</a>
        
    </p>






                    </main><footer>
    <hr />

<p><small>
        2024 &copy; 0xttfx - <a href="https://spdx.org/licenses/BSD-3-Clause">BSD-3-Clause</a>
    </small></p>
    <p><small>
        
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
